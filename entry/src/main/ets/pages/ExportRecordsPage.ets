import router from '@ohos.router';
import promptAction from '@ohos.promptAction';
import fs from '@ohos.file.fs';
import { BusinessError } from '@ohos.base';
import { RecordStore } from '../data/RecordStore';
import { CategoryItem, ConsumptionRanking, MonthlyTrend, Record, TabItem } from '../models/Record';
import { CommonTabBar, DefaultTabItems } from '../components/CommonTabBar';
import { CommonNavBar } from '../components/CommonNavBar';
import { fileUri } from '@kit.CoreFileKit';

// å…³é”®ä¿®æ”¹ï¼šä» @kit.AbilityKit å¯¼å…¥ wantConstant
import { common, wantConstant, Want } from '@kit.AbilityKit';

// å¯¼å‡ºç±»å‹æšä¸¾
enum ExportType {
  OVERVIEW = 'overview',
  CATEGORY_PIE = 'category_pie',
  RANKING = 'ranking',
  MONTHLY_TREND = 'monthly_trend',
  ALL_RECORDS = 'all_records'
}

// æ˜¾å¼æ¥å£å®šä¹‰
interface ExportOption {
  type: ExportType;
  title: string;
  icon: string;
  description: string;
}



// æœˆä»½é€‰é¡¹æ¥å£
interface MonthItem {
  year: number;
  month: number;
  label: string;
}

// æŒ‰é’®é…ç½®æ¥å£
interface ActionButton {
  text: string;
  color: string;
}

@Entry
@Component
struct ExportRecordsPage {
  private recordStore: RecordStore | undefined = undefined;

  @State currentIndex: number = 0;
  private tabItems: Array<TabItem> = DefaultTabItems;

  @State currentMonth: string = 'æœ¬æœˆ';
  @State selectedYear: number = new Date().getFullYear();
  @State selectedMonth: number = new Date().getMonth() + 1;
  @State income: number = 0;
  @State expense: number = 0;
  @State balance: number = 0;
  @State categoryData: Array<CategoryItem> = [];
  @State monthlyTrend: Array<MonthlyTrend> = [];
  @State consumptionRanking: Array<ConsumptionRanking> = [];
  @State allRecords: Record[] = [];

  @State isExporting: boolean = false;
  @State exportProgress: number = 0;
  @State lastExportedFile: string = '';
  @State showExportSuccess: boolean = false;

  private exportOptions: Array<ExportOption> = [
    {
      type: ExportType.OVERVIEW,
      title: 'æ”¶æ”¯æ¦‚è§ˆ',
      icon: 'ğŸ’°',
      description: 'å¯¼å‡ºå½“å‰æœˆä»½çš„æ”¶å…¥ã€æ”¯å‡ºã€ç»“ä½™ç»Ÿè®¡'
    },
    {
      type: ExportType.CATEGORY_PIE,
      title: 'æ”¯å‡ºåˆ†ç±»',
      icon: 'ğŸ“Š',
      description: 'å¯¼å‡ºå„åˆ†ç±»æ”¯å‡ºé‡‘é¢åŠå æ¯”'
    },
    {
      type: ExportType.RANKING,
      title: 'æ¶ˆè´¹æ’è¡Œæ¦œ',
      icon: 'ğŸ†',
      description: 'å¯¼å‡ºæ¶ˆè´¹é‡‘é¢æœ€é«˜çš„åˆ†ç±»æ’å'
    },
    {
      type: ExportType.MONTHLY_TREND,
      title: 'æœˆåº¦è¶‹åŠ¿',
      icon: 'ğŸ“ˆ',
      description: 'å¯¼å‡ºæ¯æ—¥æ”¯å‡ºè¶‹åŠ¿æ•°æ®'
    },
    {
      type: ExportType.ALL_RECORDS,
      title: 'æ‰€æœ‰è®°å½•æ˜ç»†',
      icon: 'ğŸ“‹',
      description: 'å¯¼å‡ºå®Œæ•´çš„è®°è´¦è®°å½•åˆ—è¡¨'
    }
  ];

  async aboutToAppear(): Promise<void> {
    this.recordStore = RecordStore.getInstance();
    await this.recordStore.ready();
    this.loadAllData();
  }

  private loadAllData(): void {
    this.updateStatisticData();
    this.loadAllRecords();
  }

  private loadAllRecords(): void {
    if (!this.recordStore) return;
    this.allRecords = this.recordStore.getAllRecords();
  }

  private updateStatisticData(): void {
    if (!this.recordStore) return;

    try {
      const monthRecords = this.recordStore.getRecordsByMonth(this.selectedYear, this.selectedMonth - 1);

      let totalIncome = 0;
      let totalExpense = 0;
      monthRecords.forEach((record: Record) => {
        if (record.type === 'income') {
          totalIncome += record.amount;
        } else {
          totalExpense += record.amount;
        }
      });

      this.income = totalIncome;
      this.expense = totalExpense;
      this.balance = totalIncome - totalExpense;
      this.currentMonth = `${this.selectedYear}å¹´${this.selectedMonth}æœˆ`;

      this.calculateCategoryData(monthRecords);
      this.calculateMonthlyTrend(monthRecords);
      this.calculateConsumptionRanking(monthRecords);

    } catch (error) {
      console.error('æ›´æ–°ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
    }
  }

  private calculateCategoryData(records: Record[]): void {
    const expenseRecords = records.filter(r => r.type === 'expense');
    const categoryMap = new Map<string, number>();

    expenseRecords.forEach((record: Record) => {
      const category = this.recordStore!.getCategoryById(record.category);
      const current = categoryMap.get(category.id) || 0;
      categoryMap.set(category.id, current + record.amount);
    });

    const totalExpense = this.expense;
    const categoryArray: Array<CategoryItem> = [];

    categoryMap.forEach((amount: number, categoryId: string) => {
      const category = this.recordStore!.getCategoryById(categoryId);
      const percent = totalExpense > 0 ? (amount / totalExpense) * 100 : 0;
      categoryArray.push({
        name: category.name,
        amount: amount,
        percent: percent,
        color: category.color
      });
    });

    categoryArray.sort((a: CategoryItem, b: CategoryItem) => b.amount - a.amount);
    this.categoryData = categoryArray;
  }

  private calculateMonthlyTrend(records: Record[]): void {
    const daysInMonth = new Date(this.selectedYear, this.selectedMonth, 0).getDate();
    const trendData: Array<MonthlyTrend> = [];
    const dailyExpense: Map<number, number> = new Map();

    const expenseRecords = records.filter(r => r.type === 'expense');
    expenseRecords.forEach((record: Record) => {
      const parts = record.date.split('-');
      if (parts.length === 3) {
        const day = parseInt(parts[2]);
        if (!isNaN(day)) {
          dailyExpense.set(day, (dailyExpense.get(day) || 0) + record.amount);
        }
      }
    });

    for (let day = 1; day <= daysInMonth; day++) {
      trendData.push({
        day: `${day}æ—¥`,
        amount: dailyExpense.get(day) || 0,
        month: '',
        expense: 0,
        income: 0,
        balance: 0
      });
    }

    this.monthlyTrend = trendData;
  }

  private calculateConsumptionRanking(records: Record[]): void {
    const categoryMap = new Map<string, number>();
    const expenseRecords = records.filter(r => r.type === 'expense');

    expenseRecords.forEach((record: Record) => {
      const current = categoryMap.get(record.category) || 0;
      categoryMap.set(record.category, current + record.amount);
    });

    const ranking: Array<ConsumptionRanking> = [];
    categoryMap.forEach((amount: number, categoryId: string) => {
      const category = this.recordStore!.getCategoryById(categoryId);
      ranking.push({
        category: category.name,
        amount: amount
      });
    });

    ranking.sort((a: ConsumptionRanking, b: ConsumptionRanking) => b.amount - a.amount);
    this.consumptionRanking = ranking;
  }

  private generateCSVContent(exportType: ExportType): string {
    let csvContent = '';
    const bom = '\uFEFF';

    switch (exportType) {
      case ExportType.OVERVIEW:
        csvContent = this.generateOverviewCSV();
        break;
      case ExportType.CATEGORY_PIE:
        csvContent = this.generateCategoryCSV();
        break;
      case ExportType.RANKING:
        csvContent = this.generateRankingCSV();
        break;
      case ExportType.MONTHLY_TREND:
        csvContent = this.generateTrendCSV();
        break;
      case ExportType.ALL_RECORDS:
        csvContent = this.generateAllRecordsCSV();
        break;
    }

    return bom + csvContent;
  }

  private generateOverviewCSV(): string {
    let csv = 'æ”¶æ”¯æ¦‚è§ˆæŠ¥è¡¨\n';
    csv += `ç»Ÿè®¡æœˆä»½,${this.currentMonth}\n`;
    csv += `ç”Ÿæˆæ—¶é—´,${new Date().toLocaleString()}\n\n`;
    csv += 'é¡¹ç›®,é‡‘é¢(å…ƒ),å æ¯”\n';
    csv += `æ€»æ”¶å…¥,${this.income.toFixed(2)},100%\n`;
    csv += `æ€»æ”¯å‡º,${this.expense.toFixed(2)},${this.income > 0 ? ((this.expense / this.income) * 100).toFixed(2) : '0'}%\n`;
    csv += `ç»“ä½™,${this.balance.toFixed(2)},${this.income > 0 ? ((this.balance / this.income) * 100).toFixed(2) : '0'}%\n`;
    return csv;
  }

  private generateCategoryCSV(): string {
    let csv = 'æ”¯å‡ºåˆ†ç±»ç»Ÿè®¡\n';
    csv += `ç»Ÿè®¡æœˆä»½,${this.currentMonth}\n`;
    csv += `æ€»æ”¯å‡º,${this.expense.toFixed(2)}å…ƒ\n\n`;
    csv += 'æ’å,åˆ†ç±»åç§°,é‡‘é¢(å…ƒ),å æ¯”(%),é¢œè‰²æ ‡è¯†\n';

    this.categoryData.forEach((item: CategoryItem, index: number) => {
      csv += `${index + 1},${item.name},${item.amount.toFixed(2)},${item.percent.toFixed(2)},${item.color}\n`;
    });

    return csv;
  }

  private generateRankingCSV(): string {
    let csv = 'æ¶ˆè´¹æ’è¡Œæ¦œ\n';
    csv += `ç»Ÿè®¡æœˆä»½,${this.currentMonth}\n\n`;
    csv += 'æ’å,åˆ†ç±»åç§°,æ¶ˆè´¹é‡‘é¢(å…ƒ),å æ¯”(%)\n';

    const total = this.consumptionRanking.reduce((sum: number, item: ConsumptionRanking) => sum + item.amount, 0);
    this.consumptionRanking.forEach((item: ConsumptionRanking, index: number) => {
      const percent = total > 0 ? ((item.amount / total) * 100).toFixed(2) : '0';
      csv += `${index + 1},${item.category},${item.amount.toFixed(2)},${percent}\n`;
    });

    return csv;
  }

  private generateTrendCSV(): string {
    let csv = 'æœˆåº¦æ”¯å‡ºè¶‹åŠ¿\n';
    csv += `ç»Ÿè®¡æœˆä»½,${this.currentMonth}\n\n`;
    csv += 'æ—¥æœŸ,æ”¯å‡ºé‡‘é¢(å…ƒ),æ˜ŸæœŸ\n';

    this.monthlyTrend.forEach((item: MonthlyTrend) => {
      const dayNum = parseInt(item.day);
      const date = new Date(this.selectedYear, this.selectedMonth - 1, dayNum);
      const weekDay = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'][date.getDay()];
      csv += `${item.day},${item.amount.toFixed(2)},æ˜ŸæœŸ${weekDay}\n`;
    });

    return csv;
  }

  private generateAllRecordsCSV(): string {
    let csv = 'è®°è´¦è®°å½•æ˜ç»†\n';
    csv += `å¯¼å‡ºæ—¶é—´,${new Date().toLocaleString()}\n`;
    csv += `è®°å½•æ€»æ•°,${this.allRecords.length}\n\n`;
    csv += 'åºå·,æ—¥æœŸ,æ—¶é—´,ç±»å‹,åˆ†ç±»,é‡‘é¢(å…ƒ),æè¿°,è®°å½•ID\n';

    this.allRecords.forEach((record: Record, index: number) => {
      const typeStr = record.type === 'income' ? 'æ”¶å…¥' : 'æ”¯å‡º';
      const categoryName = this.recordStore?.getCategoryById(record.category)?.name || 'æœªçŸ¥';
      csv += `${index + 1},${record.date},${record.time},${typeStr},${categoryName},${record.amount.toFixed(2)},"${record.description || ''}",${record.id}\n`;
    });

    return csv;
  }

  private async performExport(exportType: ExportType): Promise<void> {
    if (this.isExporting) return;

    this.isExporting = true;
    this.exportProgress = 0;
    this.showExportSuccess = false;

    try {
      this.exportProgress = 30;
      await new Promise<void>(resolve => setTimeout(resolve, 200));

      const csvContent = this.generateCSVContent(exportType);
      this.exportProgress = 60;

      const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
      const fileName = `è´¢åŠ¡è®°å½•_${this.getExportTypeName(exportType)}_${timestamp}.csv`;

      const context = getContext() as common.UIAbilityContext;
      const filePath = `${context.filesDir}/${fileName}`;

      const file = await fs.open(filePath, fs.OpenMode.READ_WRITE | fs.OpenMode.CREATE);
      await fs.write(file.fd, csvContent);
      await fs.close(file.fd);

      this.exportProgress = 100;
      this.lastExportedFile = filePath;
      this.showExportSuccess = true;

      promptAction.showToast({ message: 'CSVæ–‡ä»¶å·²ç”Ÿæˆ', duration: 2000 });
      await this.shareFile(filePath);

    } catch (error) {
      console.error('å¯¼å‡ºå¤±è´¥:', error);
      promptAction.showToast({ message: 'å¯¼å‡ºå¤±è´¥: ' + (error as BusinessError).message, duration: 3000 });
    } finally {
      this.isExporting = false;
    }
  }

  private getExportTypeName(type: ExportType): string {
    switch (type) {
      case ExportType.OVERVIEW: return 'æ”¶æ”¯æ¦‚è§ˆ';
      case ExportType.CATEGORY_PIE: return 'æ”¯å‡ºåˆ†ç±»';
      case ExportType.RANKING: return 'æ¶ˆè´¹æ’è¡Œæ¦œ';
      case ExportType.MONTHLY_TREND: return 'æœˆåº¦è¶‹åŠ¿';
      case ExportType.ALL_RECORDS: return 'æ‰€æœ‰è®°å½•';
      default: return 'å¯¼å‡º';
    }
  }

  private async shareFile(filePath: string): Promise<void> {
    try {
      const context = getContext() as common.UIAbilityContext;
      const uri = fileUri.getUriFromPath(filePath);

      // å…³é”®ï¼šæ˜¾å¼å£°æ˜ä¸º common.Want ç±»å‹
      const want: Want = {
        action: 'ohos.want.action.sendData',  // å­—ç¬¦ä¸²å­—é¢é‡
        type: 'text/csv',
        uri: uri,
        flags: wantConstant.Flags.FLAG_AUTH_READ_URI_PERMISSION | wantConstant.Flags.FLAG_AUTH_WRITE_URI_PERMISSION
      };

      await context.startAbility(want);
      console.log('åˆ†äº«æˆåŠŸ');
    } catch (error) {
      console.error('åˆ†äº«å¤±è´¥:', error);
      promptAction.showToast({ message: 'åˆ†äº«å¤±è´¥ï¼Œæ–‡ä»¶å·²ä¿å­˜åˆ°åº”ç”¨ç›®å½•', duration: 2000 });
    }
  }

  private async showExportConfirm(option: ExportOption): Promise<void> {
    try {
      const res = await promptAction.showDialog({
        title: `å¯¼å‡º${option.title}`,
        message: `å³å°†å¯¼å‡º${option.title}æ•°æ®ä¸ºCSVæ–‡ä»¶\n\næ–‡ä»¶åŒ…å«ï¼š${option.description}\n\nå¯¼å‡ºåå¯é€šè¿‡ç³»ç»Ÿåˆ†äº«ä¿å­˜åˆ°æœ¬åœ°æˆ–å‘é€ç»™å…¶ä»–åº”ç”¨`,
        buttons: [
          { text: 'å–æ¶ˆ', color: '#666666' },
          { text: 'ç¡®è®¤å¯¼å‡º', color: '#007AFF' }
        ]
      });

      if (res.index === 1) {
        await this.performExport(option.type);
      }
    } catch (err) {
      console.error('å¯¼å‡ºç¡®è®¤å¼‚å¸¸:', err);
    }
  }

  private async reShareFile(): Promise<void> {
    if (this.lastExportedFile) {
      await this.shareFile(this.lastExportedFile);
    }
  }

  build() {
    Column() {
      CommonNavBar({
        options: {
          showBack: true,
          onLeftClick: () => {
            router.back();
          },
          title: 'å¯¼å‡ºæ•°æ®',
        }
      });

      Scroll() {
        Column({ space: 20 }) {
          Column({ space: 12 }) {
            Text('ğŸ“… é€‰æ‹©ç»Ÿè®¡æœˆä»½')
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .fontColor('#000000')
              .width('100%')

            Row() {
              Text(this.currentMonth)
                .fontSize(16)
                .fontColor('#007AFF')
                .fontWeight(FontWeight.Medium)

              Blank()

              Button('åˆ‡æ¢æœˆä»½')
                .fontSize(14)
                .height(36)
                .backgroundColor('#F0F0F0')
                .fontColor('#007AFF')
                .onClick(() => {
                  this.showMonthPicker();
                })
            }
            .width('100%')
            .padding(16)
            .backgroundColor('#FFFFFF')
            .borderRadius(12)
          }
          .width('100%')
          .padding(16)
          .backgroundColor('#FFFFFF')
          .borderRadius(12)

          Column({ space: 12 }) {
            Text('ğŸ“¤ é€‰æ‹©å¯¼å‡ºå†…å®¹')
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .fontColor('#000000')
              .width('100%')

            ForEach(this.exportOptions, (option: ExportOption) => {
              Column({ space: 8 }) {
                Row({ space: 12 }) {
                  Text(option.icon)
                    .fontSize(24)
                    .width(40)
                    .textAlign(TextAlign.Center)

                  Column({ space: 4 }) {
                    Text(option.title)
                      .fontSize(16)
                      .fontWeight(FontWeight.Medium)
                      .fontColor('#000000')

                    Text(option.description)
                      .fontSize(13)
                      .fontColor('#666666')
                      .maxLines(2)
                      .textOverflow({ overflow: TextOverflow.Ellipsis })
                  }
                  .layoutWeight(1)
                  .alignItems(HorizontalAlign.Start)

                  Button('å¯¼å‡º')
                    .fontSize(14)
                    .height(32)
                    .backgroundColor('#007AFF')
                    .onClick(() => {
                      this.showExportConfirm(option);
                    })
                }
                .width('100%')
                .padding(16)
                .backgroundColor('#F8F8F8')
                .borderRadius(12)

                if (this.isExporting) {
                  Progress({ value: this.exportProgress, total: 100, type: ProgressType.Linear })
                    .width('100%')
                    .height(4)
                    .color('#007AFF')
                    .backgroundColor('#E0E0E0')
                }
              }
              .width('100%')
            }, (option: ExportOption) => option.type)
          }
          .width('100%')
          .padding(16)
          .backgroundColor('#FFFFFF')
          .borderRadius(12)

          if (this.showExportSuccess && this.lastExportedFile) {
            Column({ space: 12 }) {
              Text('âœ… å¯¼å‡ºæˆåŠŸ')
                .fontSize(18)
                .fontWeight(FontWeight.Bold)
                .fontColor('#34C759')
                .width('100%')
                .textAlign(TextAlign.Center)

              Text('æ–‡ä»¶å·²ä¿å­˜åˆ°åº”ç”¨ç§æœ‰ç›®å½•')
                .fontSize(14)
                .fontColor('#666666')
                .width('100%')
                .textAlign(TextAlign.Center)

              Text(`è·¯å¾„: ${this.lastExportedFile}`)
                .fontSize(12)
                .fontColor('#999999')
                .width('100%')
                .textAlign(TextAlign.Center)
                .maxLines(2)
                .textOverflow({ overflow: TextOverflow.Ellipsis })

              Button('é‡æ–°åˆ†äº«')
                .fontSize(16)
                .width('100%')
                .height(44)
                .backgroundColor('#007AFF')
                .margin({ top: 8 })
                .onClick(() => {
                  this.reShareFile();
                })

              Text('æç¤ºï¼šCSVæ–‡ä»¶å¯é€šè¿‡å¾®ä¿¡ã€é‚®ä»¶ã€æ–‡ä»¶ç®¡ç†å™¨ç­‰åº”ç”¨åˆ†äº«ä¿å­˜')
                .fontSize(12)
                .fontColor('#999999')
                .width('100%')
                .textAlign(TextAlign.Center)
                .margin({ top: 8 })
            }
            .width('100%')
            .padding(20)
            .backgroundColor('#E8F5E9')
            .borderRadius(12)
          }

          Column({ space: 8 }) {
            Text('ğŸ’¡ ä½¿ç”¨è¯´æ˜')
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
              .fontColor('#000000')
              .width('100%')

            Text('1. CSVæ–‡ä»¶å¯å¯¼å…¥Excelã€WPSç­‰è¡¨æ ¼è½¯ä»¶æŸ¥çœ‹')
              .fontSize(13)
              .fontColor('#666666')
              .width('100%')

            Text('2. å¯¼å‡ºåè¯·ä½¿ç”¨ç³»ç»Ÿåˆ†äº«åŠŸèƒ½ä¿å­˜åˆ°åˆé€‚ä½ç½®')
              .fontSize(13)
              .fontColor('#666666')
              .width('100%')

            Text('3. æ–‡ä»¶é»˜è®¤ä¿å­˜äºåº”ç”¨ç§æœ‰ç›®å½•ï¼Œå¸è½½åº”ç”¨åå°†ä¸¢å¤±')
              .fontSize(13)
              .fontColor('#FF6B6B')
              .width('100%')
          }
          .width('100%')
          .padding(16)
          .backgroundColor('#FFF8E1')
          .borderRadius(12)
        }
        .width('100%')
        .padding(20)
      }
      .width('100%')
      .height('90%')
      .backgroundColor('#F2F2F7')
      .scrollBar(BarState.Off)

      CommonTabBar({
        tabItems: this.tabItems,
        activeColor: '#FF5722',
        inactiveColor: '#999999'
      })
        .width('100%')
        .height(56)
        .backgroundColor('#FFFFFF')
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F2F2F7')
  }

  // ä½¿ç”¨ promptAction.showDialog æ›¿ä»£
  private async showMonthPicker(): Promise<void> {
    const months: Array<MonthItem> = [];
    const currentDate = new Date();

    for (let i = 0; i < 6; i++) {
      const d = new Date(currentDate.getFullYear(), currentDate.getMonth() - i, 1);
      months.push({
        year: d.getFullYear(),
        month: d.getMonth() + 1,
        label: `${d.getFullYear()}å¹´${d.getMonth() + 1}æœˆ`
      });
    }

    // æ„å»ºæ¶ˆæ¯æ–‡æœ¬
    const message = months.map((m, i) => `${i + 1}. ${m.label}`).join('\n');

    try {
      const result = await promptAction.showDialog({
        title: 'é€‰æ‹©æœˆä»½',
        message: message,
        buttons: [
          { text: '1æœˆå‰', color: '#666666' },
          { text: '2æœˆå‰', color: '#666666' },
          { text: '3æœˆå‰', color: '#666666' },
          { text: '4æœˆå‰', color: '#666666' },
          { text: '5æœˆå‰', color: '#666666' },
          { text: '6æœˆå‰', color: '#666666' }
        ]
      });

      if (result.index >= 0 && result.index < months.length) {
        const selected = months[result.index];
        this.selectedYear = selected.year;
        this.selectedMonth = selected.month;
        this.loadAllData();
      }
    } catch (error) {
      console.error('é€‰æ‹©æœˆä»½å¤±è´¥:', error);
    }
  }
}