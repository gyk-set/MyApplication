import { AiService } from '../services/AiService';
import promptAction from '@ohos.promptAction';
import preferences from '@ohos.data.preferences';
import common from '@ohos.app.ability.common';
import router from '@ohos.router';
// å¯¼å…¥é€šç”¨å¯¼èˆªæ ç»„ä»¶
import { CommonNavBar } from '../components/CommonNavBar';

/**
 * èŠå¤©æ¶ˆæ¯ç±»å‹å®šä¹‰
 */
interface ChatMessage {
  id: number;
  content: string;
  isUser: boolean;
  timestamp: number;
}

/**
 * æœ¬åœ°å­˜å‚¨æ•°æ®ç»“æ„
 */
interface ChatHistoryData {
  messages: ChatMessage[];
  messageId: number;
}

@Entry
@Component
struct AiChatPage {
  private context: common.UIAbilityContext = getContext(this) as common.UIAbilityContext;
  @State inputText: string = '';
  @State isLoading: boolean = false;
  @State messages: ChatMessage[] = [];
  // é€‚é…ä½ç‰ˆæœ¬ï¼šç”¨ ListScroller æ›¿ä»£ ListController
  private listScroller: ListScroller = new ListScroller();

  private messageId: number = 0;
  private readonly STORAGE_KEY: string = 'chat_history';
  private readonly PREF_NAME: string = 'ai_chat_preferences';
  private pref: preferences.Preferences | null = null;
  @State showQuickAsk: boolean = false;

  private readonly quickQuestions: string[] = [
    "ä½ å¥½ï¼Œæˆ‘çš„AIåŠ©æ‰‹",
    "å¦‚ä½•å¿«é€Ÿè®°è´¦ï¼Œè¯·ç®€å•å›å¤ï¼Ÿ",
    "è®°è´¦çš„å¥½å¤„éƒ½æœ‰å“ªäº›ï¼Œç®€å•å›å¤ï¼Ÿ",
    "æ•™æˆ‘é›¶åŸºç¡€ä¸ªäººè®°è´¦çš„æ ¸å¿ƒæ–¹æ³•ï¼Œè¦æ±‚æ­¥éª¤ç®€å•ã€æ˜“åšæŒï¼Œé€‚åˆæœˆè–ªæ—æ—¥å¸¸ä½¿ç”¨",
    "æ¨è 3 ä¸ªé€‚åˆæ™®é€šäººçš„è®°è´¦åŸåˆ™ï¼Œèƒ½é¿å…æ¼è®°ã€ä¹±è®°ï¼Œå¿«é€Ÿç†æ¸…æ”¶æ”¯",
    "å¸®æˆ‘æ¢³ç†ä¸ªäººè®°è´¦çš„å¿…å¤‡ç§‘ç›®ï¼Œä¸ç”¨å¤ªå¤æ‚ï¼Œè¦†ç›–æ—¥å¸¸å·¥èµ„ã€é¥®é£Ÿã€äº¤é€šã€å¨±ä¹å³å¯",
    "æ•™æˆ‘å­¦ç”Ÿå…šæç®€è®°è´¦æ³•ï¼Œä¸»æ‰“ä½æˆæœ¬ã€æ˜“æ“ä½œï¼Œé€‚é…ç”Ÿæ´»è´¹æœ‰é™ã€æ¶ˆè´¹å•ä¸€çš„åœºæ™¯",
    "è®¾è®¡ä¸€ä»½ä¸Šç­æ—æœˆåº¦è®°è´¦æ¨¡æ¿ï¼ŒåŒ…å«å›ºå®šå¼€æ”¯ã€çµæ´»æ¶ˆè´¹ã€å‚¨è“„ç›®æ ‡ï¼Œå¯ç›´æ¥å¥—ç”¨",
    "æ•™æˆ‘å®¶åº­åˆä¼™è®°è´¦çš„æ–¹æ³•ï¼Œèƒ½æ¸…æ™°åˆ’åˆ†å…±åŒå¼€æ”¯å’Œä¸ªäººå¼€æ”¯ï¼Œé¿å…è´¦ç›®çº çº·",
    "é€‚åˆè‡ªç”±èŒä¸šè€…çš„è®°è´¦æŠ€å·§ï¼Œå…¼é¡¾æ”¶å…¥ä¸å›ºå®šã€å¤šå¹³å°æ”¶æ¬¾ã€æˆæœ¬æ ¸ç®—çš„éœ€æ±‚",
    "æ•™æˆ‘æç®€æ”’é’±å¼è®°è´¦æ³•ï¼Œæ ¸å¿ƒæ˜¯é€šè¿‡è®°è´¦æ§åˆ¶éå¿…è¦æ¶ˆè´¹ï¼Œå¿«é€Ÿæ”’ä¸‹ç¬¬ä¸€ç¬”é’±"
  ];
  /**
   * é¡µé¢æ˜¾ç¤ºç”Ÿå‘½å‘¨æœŸ
   */
  async aboutToAppear(): Promise<void> {
    await this.initPreferences();
    await this.loadChatHistory();
    // é¡µé¢æ‰“å¼€åå»¶è¿Ÿæ»šåŠ¨åˆ°åº•éƒ¨ï¼ˆé€‚é…ä½ç‰ˆæœ¬ï¼‰
    setTimeout(() => {
      this.scrollToBottom();
    }, 150);
  }

  /**
   * åˆå§‹åŒ–æœ¬åœ°å­˜å‚¨
   */
  private async initPreferences(): Promise<void> {
    try {
      this.pref = await preferences.getPreferences(this.context, this.PREF_NAME);
    } catch (error) {
      console.error("å­˜å‚¨åˆå§‹åŒ–å¤±è´¥");
    }
  }

  /**
   * åŠ è½½èŠå¤©å†å²
   */
  async loadChatHistory(): Promise<void> {
    if (!this.pref) return;
    try {
      const savedHistory = await this.pref.get(this.STORAGE_KEY, "") as string;
      if (savedHistory) {
        const history = JSON.parse(savedHistory) as ChatHistoryData;
        this.messages = Array.isArray(history.messages) ? history.messages : [];
        this.messageId = typeof history.messageId === "number" ? history.messageId : 0;
      }
    } catch (error) {
      this.messages = [];
      this.messageId = 0;
    }
  }

  /**
   * ä¿å­˜èŠå¤©å†å²
   */
  private async saveChatHistory(): Promise<void> {
    if (!this.pref) return;
    try {
      const data: ChatHistoryData = {
        messages: this.messages,
        messageId: this.messageId
      };
      await this.pref.put(this.STORAGE_KEY, JSON.stringify(data));
      await this.pref.flush();
    } catch {}
  }

  /**
   * æ¸…ç©ºå¯¹è¯å†å²
   */
  async clearHistory(): Promise<void> {
    if (!this.pref) return;
    this.messages = [];
    this.messageId = 0;
    await this.pref.delete(this.STORAGE_KEY);
    await this.pref.flush();
    promptAction.showToast({ message: "å·²æ¸…ç©º", duration: 2000 });
  }

  /**
   * æ·»åŠ æ¶ˆæ¯
   */
  private addMessage(content: string, isUser: boolean): void {
    const id = this.messageId++;
    this.messages = [...this.messages, {
      id: id,
      content: content,
      isUser: isUser,
      timestamp: Date.now()
    }];
    this.saveChatHistory();
    // æ·»åŠ æ¶ˆæ¯åç«‹å³æ»šåŠ¨åˆ°åº•éƒ¨
    setTimeout(() => {
      this.scrollToBottom();
    }, 50);
  }

  /**
   * æ—¶é—´æ ¼å¼åŒ–
   */
  private formatTime(timestamp: number): string {
    const d: Date = new Date(timestamp);
    const h: string = d.getHours().toString().padStart(2, "0");
    const m: string = d.getMinutes().toString().padStart(2, "0");
    return h + ":" + m;
  }

  /**
   * æ»šåŠ¨åˆ°åˆ—è¡¨æœ€åä¸€æ¡æ¶ˆæ¯ï¼ˆé€‚é…æœ€ä½ç‰ˆæœ¬ï¼šç”¨ scrollTo å®ç°ï¼‰
   */
  private scrollToBottom(): void {
    if (this.messages.length > 0) {
      // æœ€ä½ç‰ˆæœ¬APIï¼šæ»šåŠ¨åˆ°æœ€å¤§åç§»é‡ï¼Œç¡®ä¿æ»šåˆ°åº•éƒ¨
      this.listScroller.scrollTo({
        xOffset: 0,
        yOffset: 99999,
        animation: true
      });
    }
  }

  /**
   * è¿”å›æŒ‰é’®ç‚¹å‡»äº‹ä»¶
   */
  private onBackClick(): void {
    try {
      router.back();
    } catch (error) {
      console.error("è¿”å›å¤±è´¥:", error);
    }
  }

  /**
   * å‘é€æ¶ˆæ¯æ ¸å¿ƒé€»è¾‘
   */
  async sendMessage(): Promise<void> {
    const text: string = this.inputText.trim();
    if (!text || this.isLoading) {
      return;
    }

    this.isLoading = true;
    const sendText: string = text;
    this.inputText = "";

    this.addMessage(sendText, true);

    try {
      const res: string = await AiService.chat(sendText);
      this.addMessage(res, false);
    } catch (error) {
      let msg: string = "è¯·æ±‚å¤±è´¥ï¼Œè¯·é‡è¯•";
      try {
        if (error instanceof Error) {
          msg = error.message;
        }
      } catch {}
      this.addMessage("âŒ " + msg, false);
      promptAction.showToast({ message: msg, duration: 2500, bottom: 200 });
    } finally {
      setTimeout((): void => {
        this.isLoading = false;
      }, 0);
    }
  }

  build() {
    Stack() {
      Column({ space: 0 }) {
        // ========== ä½¿ç”¨é€šç”¨å¯¼èˆªæ ç»„ä»¶ï¼Œå³ä¾§æŒ‰é’®å®ç°æ¸…ç©ºå†å² ==========
        CommonNavBar({
          options: {
            showBack: true,
            title: "è½»è®°AIæ™ºèƒ½åŠ©æ‰‹",
            backIconColor: "#fff",
            rightText: 'æ¸…å†å²', // æ¸…ç©ºå›¾æ ‡åç§°
            onLeftClick: this.onBackClick.bind(this),
            onRightClick: async () => {
              await this.clearHistory();
            }
          }
        });

        // æ¶ˆæ¯åˆ—è¡¨åŒºåŸŸï¼ˆå æ»¡å‰©ä½™ç©ºé—´ï¼Œè¾“å…¥æ¡†å¼¹å‡ºæ—¶è¢«æŒ¤å‹ï¼‰
        Column() {
          if (this.messages.length === 0) {
            Column() {
              Image($r('app.media.logo1'))
                .width(100)
                .height(100)
                .opacity(0.8)
                .borderRadius(50); // æ·»åŠ åœ†è§’ï¼Œæ•°å€¼è¶Šå¤§åœ†è§’è¶Šæ˜æ˜¾
              Text("ä½ å¥½ï¼æˆ‘æ˜¯AIåŠ©æ‰‹")
                .fontSize(20)
                .fontWeight(FontWeight.Medium)
                .margin({ top: 20, bottom: 8 });
              Text("æˆ‘å¯ä»¥å›ç­”å„ç§é—®é¢˜ï¼Œè¯•è¯•é—®æˆ‘å§ï¼")
                .fontSize(14)
                .fontColor("#666666")
                .margin({ bottom: 24 });

              Column({ space: 12 }) {
                ForEach(
                  ["ä½ å¥½ï¼Œæˆ‘çš„AIåŠ©æ‰‹", "å¦‚ä½•å¿«é€Ÿè®°è´¦ï¼Œè¯·ç®€å•å›å¤ï¼Ÿ", "è®°è´¦çš„å¥½å¤„éƒ½æœ‰å“ªäº›ï¼Œç®€å•å›å¤ï¼Ÿ"],
                  (item: string) => {
                    Text(item)
                      .fontSize(13)
                      .fontColor("#007dff")
                      .padding({
                        left: 16,
                        right: 16,
                        top: 8,
                        bottom: 8
                      })
                      .backgroundColor("#007dff10")
                      .borderRadius(20)
                      .border({ width: 1, color: "#007dff30" })
                      .onClick((): void => {
                        this.inputText = item;
                      });
                  },
                  (item: string) => item
                );
              }
            }
            .width("100%")
            .height("100%")
            .justifyContent(FlexAlign.Center)
            .alignItems(HorizontalAlign.Center);
          } else {
            List({ space: 16, scroller: this.listScroller }) {
              ForEach(
                this.messages,
                (msg: ChatMessage) => {
                  ListItem() {
                    Column({ space: 6 }) {
                      if (msg.isUser) {
                        // ç”¨æˆ·æ¶ˆæ¯åŒºåŸŸ - å¸¦å¤´åƒ
                        Column() {
                          // ç”¨æˆ·ä¿¡æ¯è¡Œï¼šå¤´åƒ + åç§° + æ—¶é—´
                          Row() {
                            Text(this.formatTime(msg.timestamp))
                              .fontSize(10)
                              .fontColor("#999999")
                              .margin({ right: 8 });
                            Text("ä½ ")
                              .fontSize(12)
                              .fontColor("#666666")
                              .margin({ right: 8 });
                            // ç”¨æˆ·å¤´åƒ
                            Image($r('app.media.User_Avatar'))
                              .width(24)
                              .height(24)
                              .borderRadius(12) // åœ†å½¢å¤´åƒ
                              .objectFit(ImageFit.Cover);
                          }
                          .justifyContent(FlexAlign.End)
                          .width("100%");

                          // ç”¨æˆ·æ¶ˆæ¯å†…å®¹è¡Œ
                          Row() {
                            Text(msg.content)
                              .fontSize(15)
                              .fontColor("#ffffff")
                              .padding(12)
                              .backgroundColor("#007dff")
                              .borderRadius({
                                topLeft: 12,
                                topRight: 4,
                                bottomLeft: 12,
                                bottomRight: 12
                              })
                          }
                          .justifyContent(FlexAlign.End)
                          .width("80%");
                        }
                      } else {
                        // AIåŠ©æ‰‹æ¶ˆæ¯åŒºåŸŸ - å¸¦å¤´åƒ
                        Column() {
                          // AIä¿¡æ¯è¡Œï¼šå¤´åƒ + åç§° + æ—¶é—´
                          Row() {
                            // AIå¤´åƒ
                            Image($r('app.media.logo1'))
                              .width(24)
                              .height(24)
                              .borderRadius(12) // åœ†å½¢å¤´åƒ
                              .objectFit(ImageFit.Cover)
                              .margin({ right: 8 });
                            Text("AIåŠ©æ‰‹")
                              .fontSize(12)
                              .fontColor("#666666")
                              .margin({ right: 8 });
                            Text(this.formatTime(msg.timestamp))
                              .fontSize(10)
                              .fontColor("#999999");
                          }
                          .justifyContent(FlexAlign.Start)
                          .width("100%");

                          // AIæ¶ˆæ¯å†…å®¹è¡Œ
                          Row() {
                            Text(msg.content)
                              .fontSize(15)
                              .fontColor("#333333")
                              .padding(12)
                              .backgroundColor("#f0f0f0")
                              .borderRadius({
                                topLeft: 4,
                                topRight: 12,
                                bottomLeft: 12,
                                bottomRight: 12
                              })
                          }
                          .justifyContent(FlexAlign.Start)
                          .width("80%");
                        }
                      }
                    }
                    .margin({ top: 4, bottom: 4 });
                  }
                },
                (msg: ChatMessage) => msg.id.toString()
              );
            }
            .width("100%")
            .height("100%")
            .padding(16)
            .scrollBar(BarState.Off)
            .backgroundColor("#ffffff");
          }
        }
        .layoutWeight(1)
        .backgroundColor("#ffffff");

        // ===================== è¾“å…¥æ¡†åŒºåŸŸï¼ˆåœ¨æç¤ºä¸Šæ–¹ï¼Œè·Ÿéšé”®ç›˜ï¼‰ =====================
        Column() {
          Row({ space: 12 }) {
            TextInput({
              placeholder: "è¾“å…¥æ‚¨çš„é—®é¢˜...",
              text: this.inputText
            })
              .layoutWeight(1)
              .height(44)
              .backgroundColor("#f8f9fa")
              .padding({ left: 16, right: 16 })
              .borderRadius(22)
              .maxLength(500)
              .onChange((v: string): void => {
                this.inputText = v;
              })
              .onSubmit((): void => {
                this.sendMessage();
              });

            Button() {
              Image($r('app.media.send_icon'))
                .width(24)
                .height(24);
            }
            .width(44)
            .height(44)
            .borderRadius(22)
            .backgroundColor(this.inputText.trim() !== "" && !this.isLoading ? "#007dff" : "#e0e0e0")
            .enabled(this.inputText.trim() !== "" && !this.isLoading)
            .onClick((): void => {
              this.sendMessage();
            });
          }
          .width("100%")
          .padding({
            left: 16,
            right: 16,
            top: 12,
            bottom: 8
          });
        }
        .backgroundColor("#ffffff")
        .border({ width: 1, color: "#f0f0f0" });

        // ===================== å›ºå®šåº•éƒ¨æç¤ºæ ï¼ˆæ°¸è¿œè´´åº•ï¼Œä¸ç§»åŠ¨ã€ä¸è¢«é”®ç›˜é¡¶èµ·ï¼‰ =====================
        Row() {
          Text("ğŸ’¡ AIå¯èƒ½ä¼šäº§ç”Ÿä¸å‡†ç¡®ä¿¡æ¯ï¼Œè¯·è°¨æ…æ ¸å®")
            .fontSize(11)
            .fontColor("#999999");
        }
        .width("100%")
        .height(30)
        .justifyContent(FlexAlign.Center)
        .alignItems(VerticalAlign.Center)
        .backgroundColor("#ffffff")
        .zIndex(-1);
      }

      this.buildQuickAskPanel()
    }
    .width("100%")
    .height("100%")
    .backgroundColor("#ffffff");
  }
  @Builder
  private buildQuickAskPanel() {
    if (!this.showQuickAsk) {
      // åªæ˜¾ç¤ºæ‚¬æµ®æŒ‰é’®
      Button() {
        Column() {
          Text("å¿«")
          Text("é€Ÿ")
          Text("æ")
          Text("é—®")
        }
        .height("100%")
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
        .margin({ top: 4, bottom: 4 })
      }
      .fontSize(12)
      .fontColor("#ffffff")
      .backgroundColor("#3399FF")
      .borderRadius(25)
      .width("10%")
      .height(100)
      .position({
        x: '90%',
        y: '70%'
      })
      .zIndex(100)
      .onClick(() => {
        this.showQuickAsk = true;
      })
    }

    // ========== å±•å¼€æ€ ==========
    if (this.showQuickAsk) {
      Stack() {
        // 1ï¸âƒ£ åŠé€æ˜é®ç½©ï¼ˆç‚¹ç©ºç™½å…³é—­ï¼‰
        Column()
          .width("100%")
          .height("100%")
          .backgroundColor("#00000040")
          .onClick(() => {
            this.showQuickAsk = false;
          });

        // 2ï¸âƒ£ å³ä¸‹è§’å±•å¼€çš„é¢æ¿ï¼ˆå  1/4 å±å¹•ï¼‰ï¼Œå¯æ»šåŠ¨
        Column({ space: 0 }) {
          // æ ‡é¢˜åŒºåŸŸ - å›ºå®šé«˜åº¦
          Row({ space: 0 }) {
            Text("å¿«é€Ÿæé—®")
              .fontSize(16)
              .fontWeight(FontWeight.Medium)
              .flexGrow(1)
              .textAlign(TextAlign.Start)

            Button() {
              Image($r('app.media.ic_close'))
                .width(16)
                .height(16)
                .fillColor("#999999")
            }
            .width(24)
            .height(24)
            .backgroundColor(Color.Transparent)
            .onClick(() => {
              this.showQuickAsk = false;
            })
          }
          .width("100%")
          .height(56) // å›ºå®šé«˜åº¦
          .justifyContent(FlexAlign.SpaceBetween)
          .alignItems(VerticalAlign.Center)
          .padding({ left: 16, right: 16 })
          .border({ width: { bottom: 1 }, color: "#f0f0f0" })

          // å¯æ»šåŠ¨çš„é—®é¢˜åˆ—è¡¨åŒºåŸŸ
          Column() {
            Scroll() {
              Column({ space: 8 }) {
                ForEach(this.quickQuestions, (item: string) => {
                  Text(item)
                    .fontSize(14)
                    .fontColor("#333333")
                    .padding({ left: 12, right: 12, top: 10, bottom: 10 })
                    .backgroundColor("#f9f9f9")
                    .borderRadius(8)
                    .border({ width: 1, color: "#eeeeee" })
                    .width("100%")
                    .onClick(() => {
                      this.inputText = item;
                      this.showQuickAsk = false;
                    });
                })
              }
              .padding(16)
              .width("100%")
            }
            .scrollable(ScrollDirection.Vertical)
            .scrollBar(BarState.Auto)
            .scrollBarColor("#cccccc")
            .scrollBarWidth(4)
          }
          .width("100%")
          .layoutWeight(1) // å…³é”®ï¼šå æ®å‰©ä½™æ‰€æœ‰é«˜åº¦
        }
        .width("50%")
        .height("50%")
        .backgroundColor("#ffffff")
        .borderRadius(16)
        .shadow({
          radius: 16,
          color: "#00000030",
          offsetX: 0,
          offsetY: 6
        })
        .position({
          x: '45%',
          y: '35%'
        });
      }
      .width("100%")
      .height("100%")
      .zIndex(99);
    }
  }


}