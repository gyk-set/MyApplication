import router from '@ohos.router';
import promptAction from '@ohos.promptAction';
import { RecordStore } from '../data/RecordStore';
import { DateUtils } from '../utils/DateUtils';
import { TabItem } from '../models/Record'
import { CommonTabBar, DefaultTabItems } from '../components/CommonTabBar';
import { CommonNavBar } from '../components/CommonNavBar';

@Entry
@Component
struct MainPage {
  private recordStore: RecordStore | undefined = undefined;
  @State currentDate: string = '';
  @State todaySpend: number = 0;
  @State yesterdayChange: string = '0%';
  @State expense: number = 0;
  @State income: number = 0;
  // å½“å‰é€‰ä¸­çš„Tabç´¢å¼•ï¼ˆç”¨äºé«˜äº®å›¾æ ‡/æ–‡å­—ï¼‰
  @State currentIndex: number = 0;
  // åº•éƒ¨Tabé…ç½®
  private tabItems: Array<TabItem> = DefaultTabItems;

  // æ•°æ®å˜æ›´ç›‘å¬å›è°ƒï¼ˆç”¨äºé”€æ¯æ—¶å–æ¶ˆç›‘å¬ï¼‰
  private dataChangeListener: () => void = () => {};

  async aboutToAppear(): Promise<void> {
    this.recordStore = RecordStore.getInstance();
    await this.recordStore.ready();
    this.currentDate = DateUtils.formatChineseDate(DateUtils.getCurrentDate());
    this.updateData();

    // æ³¨å†Œæ•°æ®å˜æ›´ç›‘å¬
    this.dataChangeListener = () => {
      console.log('MainPage: æ”¶åˆ°æ•°æ®å˜æ›´é€šçŸ¥ï¼Œåˆ·æ–°æ•°æ®');
      this.updateData();
    };
    this.recordStore.onDataChanged(this.dataChangeListener);
  }

  // é¡µé¢é”€æ¯æ—¶å–æ¶ˆç›‘å¬ï¼Œé¿å…å†…å­˜æ³„æ¼
  aboutToDisappear(): void {
    if (this.recordStore && this.dataChangeListener) {
      this.recordStore.offDataChanged(this.dataChangeListener);
      console.log('MainPage: å–æ¶ˆæ•°æ®å˜æ›´ç›‘å¬');
    }
  }

  private updateData(): void {
    if (!this.recordStore) {
      return;
    }
    this.todaySpend = this.recordStore.getTodayExpense();
    this.expense = this.recordStore.getTodayExpense();
    this.income = this.recordStore.getTodayIncome();
    this.yesterdayChange = this.recordStore.getExpenseChangePercent();

  }

  // æ–°å¢ï¼šè·³è½¬æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶å¤„ç†å‡½æ•°
  private navigateToOtherPage() {
    // è¿™é‡Œæ›¿æ¢ä¸ºä½ è¦è·³è½¬çš„é¡µé¢è·¯å¾„ï¼ˆä¾‹å¦‚ï¼šè®°è´¦è¯¦æƒ…é¡µ/ç»Ÿè®¡é¡µ/è®¾ç½®é¡µï¼‰
    router.pushUrl({
      url: 'pages/AiChatPage' // è¯·æ ¹æ®å®é™…é¡µé¢è·¯å¾„ä¿®æ”¹
    });
  }

  build() {
    Column() {
      // 1. é¡¶éƒ¨å¯¼èˆªæ ï¼ˆCommonNavBarï¼‰
      CommonNavBar({

        options: {
          showBack: false,
          title: 'è½»è®°ï¼Œä¸€æ¬¾ä¸“æ³¨äºè®°è´¦çš„è½¯ä»¶',

        }
      });
      // ========== ä¸»å†…å®¹åŒºåŸŸ ==========
      Scroll() {
        Column({ space: 0 }) {
          // é¡¶éƒ¨å ä½ç©ºé—´ï¼ˆ10%ï¼‰
          Column()
            .height('20%')
            .width('100%')

          // ä»Šæ—¥æ¶ˆè´¹å¡ç‰‡
          Column() {
            Row() {
              Text('ä»Šæ—¥æ¶ˆè´¹')
                .fontSize(16)
                .fontColor('#666666');
              Blank();
              Button('åˆ·æ–°')
                .fontSize(13)
                .fontColor('#007AFF')
                .backgroundColor('#FFFFFF')
                .borderRadius(8)
                .padding({
                  left: 10,
                  right: 10,
                  top: 4,
                  bottom: 4
                })
                .onClick(() => {
                  this.updateData();
                  promptAction.showToast({ message: 'å·²åˆ·æ–°ä»Šæ—¥æ•°æ®' });
                });
            }
            .width('100%')
            .padding({ left: 20, right: 20, top: 16 })

            Text('Â¥ ' + this.todaySpend.toFixed(2))
              .fontSize(32)
              .fontWeight(FontWeight.Bold)
              .fontColor('#000000')
              .margin({ left: 20, top: 8, bottom: 8 });

            Row() {
              Text('è¾ƒæ˜¨æ—¥')
                .fontSize(14)
                .fontColor('#666666');
              Text(this.yesterdayChange)
                .fontSize(14)
                .fontColor(this.yesterdayChange.includes('+') ? '#FF3B30' : '#34C759')
                .margin({ left: 6 });
            }
            .padding({ left: 20, right: 20, bottom: 16 });

            Row() {
              Column() {
                Text('æ”¯å‡º')
                  .fontSize(14)
                  .fontColor('#666666');
                Text('Â¥ ' + this.expense.toFixed(2))
                  .fontSize(18)
                  .fontWeight(FontWeight.Bold)
                  .fontColor('#FF3B30');
              }
              .flexGrow(1)
              .alignItems(HorizontalAlign.Center);

              Divider().vertical(true).height(32).color('#E5E5EA');

              Column() {
                Text('æ”¶å…¥')
                  .fontSize(14)
                  .fontColor('#666666');
                Text('Â¥ ' + this.income.toFixed(2))
                  .fontSize(18)
                  .fontWeight(FontWeight.Medium)
                  .fontColor('#34C759');
              }
              .flexGrow(1)
              .alignItems(HorizontalAlign.Center);
            }
            .width('100%')
            .padding({ left: 20, right: 20, bottom: 20 });
          }
          .width('90%')
          .backgroundColor('#FFFFFF')
          .borderRadius(16)
          .shadow({
            radius: 8,
            color: '#1A000000',
            offsetX: 0,
            offsetY: 2
          })
          .margin({ left: '5%', right: '5%' }) // ä½¿ç”¨marginä»£æ›¿alignSelfå®ç°å±…ä¸­

          // æ¬¢è¿è¯­
          Column() {
            Text('æ¬¢è¿ä½¿ç”¨è½»è®°ï¼Œæ‚¨çš„æ¯ä¸€æ¬¡è®°å½•éƒ½å°†æ˜¯ç¾å¥½çš„')
              .fontSize(14)
              .fontWeight(FontWeight.Medium)
              .fontColor('#333333')
              .textAlign(TextAlign.Center)
              .width('100%')
              .padding(16);
          }
          .width('100%')

          // ä¸­é—´åˆ°AIå¡ç‰‡ä¹‹é—´çš„å ä½ç©ºé—´
          Column()
            .layoutWeight(1) // å†å æ®ä¸€éƒ¨åˆ†ç©ºé—´
            .width('100%')
            .justifyContent(FlexAlign.End) // å¯¹é½åˆ°åº•éƒ¨

          // AIåŠ©æ‰‹å¡ç‰‡ï¼ˆè·ç¦»åº•éƒ¨10%ï¼‰
          Column({ space: 12 }) {
            // ä¸Šéƒ¨åˆ†ï¼šAIåŠ©æ‰‹å¡ç‰‡
            Row({ space: 16 }) {
              // å·¦ä¾§å›¾æ ‡
              Column()
                .width(50)
                .height(50)
                .backgroundImage($r('app.media.logo1'))
                .backgroundImageSize(ImageSize.Cover)
                .borderRadius(35) // åœ†å½¢
                .border({ width: 2, color: '#FFFFFF' })
                .shadow({
                  radius: 4,
                  color: '#00000010',
                  offsetX: 0,
                  offsetY: 2
                })

              // ä¸­é—´æ–‡å­—
              Column({ space: 4 }) {
                Text('è½»è®°AIåŠ©æ‰‹')
                  .fontSize(14)
                  .fontWeight(FontWeight.Medium)
                  .fontColor('#333333')

                Text('æ™ºèƒ½é—®ç­”ï¼Œå¿«é€Ÿè§£å†³è®°è´¦é—®é¢˜')
                  .fontSize(10)
                  .fontColor('#666666')
              }
              .layoutWeight(1)

              // å³ä¾§ä½“éªŒæŒ‰é’®
              Button('ä½“éªŒ')
                .fontSize(14)
                .fontColor('#FFFFFF')
                .fontWeight(FontWeight.Medium)
                .backgroundColor('#FF5722')
                .borderRadius(16)
                .width(60)
                .height(32)
            }
            .padding(16)
            .backgroundColor('#FFFFFF')
            .borderRadius(12)
            .border({ width: 1, color: '#F0F0F0' })
            .shadow({
              radius: 6,
              color: '#00000008',
              offsetX: 0,
              offsetY: 2
            })
            .onClick(() => {
              this.navigateToOtherPage();
            })

            // ä¸‹éƒ¨åˆ†ï¼šæç¤ºä¿¡æ¯
            Row() {
              Text('ğŸ’¡ å°æç¤º')
                .fontSize(14)
                .fontColor('#FF5722')
                .fontWeight(FontWeight.Medium)

              Text('è¯•è¯•AIåŠ©æ‰‹ï¼Œè®©è®°è´¦æ›´æ™ºèƒ½')
                .fontSize(14)
                .fontColor('#666666')
                .margin({ left: 8 })
            }
            .margin({ left: '5%', right: '5%' })
          }
          .width('90%')
          .margin({ left: '5%', right: '5%', bottom: '10%' }) // ä½¿ç”¨marginå®ç°å±…ä¸­

          // ç§»é™¤ï¼šåŸåº•éƒ¨56pxçš„å ä½ç©ºé—´ï¼ˆå¯¼èˆªæ ä¸å†éœ€è¦å†…éƒ¨å ä½ï¼‰
        }
        .width('100%')
        .height('100%')
      }
      // å…³é”®ä¿®æ”¹1ï¼šå°†Scrollé«˜åº¦æ”¹ä¸º90%ï¼Œå’Œè®°è´¦/æˆ‘çš„é¡µé¢å®Œå…¨ä¸€è‡´
      .width('100%')
      .height('90%')
      .backgroundColor('#F5F5F5')
      .scrollBar(BarState.Off);

      // åº•éƒ¨å¯¼èˆªæ ï¼ˆå±æ€§å’Œå±‚çº§ä¸å…¶ä»–é¡µé¢å®Œå…¨å¯¹é½ï¼‰
      CommonTabBar({
        tabItems: this.tabItems,
        activeColor: '#FF5722',
        inactiveColor: '#999999'
      })
        .width('100%')
        //.height(56) // å›ºå®š56pxé«˜åº¦ï¼Œå’Œå…¶ä»–é¡µé¢ä¸€è‡´
        .backgroundColor('#FFFFFF');
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F7F7F7');
  }
}