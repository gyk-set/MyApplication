// pages/ForgotPage.ets
import router from '@ohos.router';
import promptAction from '@ohos.promptAction';
import pasteboard from '@ohos.pasteboard';
import { CommonNavBar } from '../components/CommonNavBar';
import { getPasswordByUsername, decryptPwd } from '../DatabaseUtil';

@Entry
@Component
struct ForgotPage {
  @State username: string = ''; // è¾“å…¥çš„ç”¨æˆ·å
  @State isLoading: boolean = false; // åŠ è½½çŠ¶æ€
  @State foundPassword: string = ''; // æ‰¾åˆ°çš„åŸå¯†ç ï¼ˆæ˜æ–‡ï¼‰
  @State showResult: boolean = false; // æ˜¯å¦æ˜¾ç¤ºç»“æœ

  // æŸ¥è¯¢å¹¶è§£å¯†å¯†ç 
  private async handleQueryPassword(): Promise<void> {
    if (this.isLoading) return;

    if (!this.username.trim()) {
      promptAction.showToast({ message: 'è¯·è¾“å…¥ç”¨æˆ·å' });
      return;
    }

    this.isLoading = true;
    this.showResult = false;
    this.foundPassword = '';

    try {
      // è·å–åŠ å¯†åçš„å¯†ç 
      const encryptedPassword = await getPasswordByUsername(this.username.trim());

      if (encryptedPassword) {
        // è§£å¯†å¯†ç 
        this.foundPassword = decryptPwd(encryptedPassword);

        if (this.foundPassword) {
          this.showResult = true;
          promptAction.showToast({ message: 'æŸ¥è¯¢æˆåŠŸ', duration: 2000 });
        } else {
          promptAction.showToast({ message: 'å¯†ç è§£å¯†å¤±è´¥', duration: 2000 });
        }
      } else {
        promptAction.showToast({ message: 'è¯¥ç”¨æˆ·åä¸å­˜åœ¨', duration: 2000 });
      }
    } catch (error) {
      console.error('æŸ¥è¯¢å¯†ç å¤±è´¥:', error);
      promptAction.showToast({ message: 'æŸ¥è¯¢å¤±è´¥ï¼Œè¯·é‡è¯•', duration: 2000 });
    } finally {
      this.isLoading = false;
    }
  }

  // å¤åˆ¶å¯†ç åˆ°å‰ªè´´æ¿
  private async copyPassword(): Promise<void> {
    try {
      const pasteData = pasteboard.createData(pasteboard.MIMETYPE_TEXT_PLAIN, this.foundPassword);
      const systemPasteboard = pasteboard.getSystemPasteboard();
      await systemPasteboard.setData(pasteData);

      promptAction.showToast({ message: 'å¯†ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', duration: 2000 });
    } catch (error) {
      promptAction.showToast({ message: 'å¤åˆ¶å¤±è´¥', duration: 2000 });
    }
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      CommonNavBar({
        options: {
          showBack: true,
          title: 'å¿˜è®°å¯†ç ',
          onLeftClick: () => {
            router.replaceUrl({ url: 'pages/LoginPage' });
          }
        }
      });

      Scroll() {
        Column({ space: 20 }) {
          // é¡µé¢æ ‡é¢˜
          Column({ space: 8 }) {
            Text('ğŸ” æ‰¾å›å¯†ç ')
              .fontSize(28)
              .fontWeight(FontWeight.Bold)
              .fontColor('#000000')

            Text('è¯·è¾“å…¥æ‚¨çš„ç”¨æˆ·åæŸ¥è¯¢åŸå¯†ç ')
              .fontSize(14)
              .fontColor('#666666')
          }
          .width('100%')
          .margin({ top: 40, bottom: 20 })

          // è¾“å…¥åŒºåŸŸ
          Column({ space: 16 }) {
            // ç”¨æˆ·åè¾“å…¥
            Column({ space: 8 }) {
              Text('ç”¨æˆ·å')
                .fontSize(14)
                .fontColor('#333333')
                .width('100%')
                .textAlign(TextAlign.Start)

              TextInput({ placeholder: 'è¯·è¾“å…¥æ‚¨çš„ç”¨æˆ·å', text: this.username })
                .placeholderColor('#999999')
                .height(48)
                .width('100%')
                .backgroundColor('#F5F5F5')
                .borderRadius(8)
                .padding({ left: 16, right: 16 })
                .onChange((value: string) => {
                  this.username = value;
                })
            }
            .width('100%')

            // æŸ¥è¯¢æŒ‰é’®
            Button(this.isLoading ? 'æŸ¥è¯¢ä¸­...' : 'æŸ¥è¯¢åŸå¯†ç ', {
              type: ButtonType.Capsule,
              stateEffect: true
            })
              .width('100%')
              .height(48)
              .backgroundColor(this.isLoading ? '#CCCCCC' : '#007AFF')
              .fontColor('#FFFFFF')
              .fontSize(16)
              .enabled(!this.isLoading)
              .onClick(() => {
                this.handleQueryPassword();
              })

            // è¿”å›ç™»å½•æŒ‰é’®
            Button('è¿”å›ç™»å½•', {
              type: ButtonType.Capsule,
              stateEffect: true
            })
              .width('100%')
              .height(48)
              .backgroundColor('#FFFFFF')
              .fontColor('#007AFF')
              .borderColor('#007AFF')
              .borderWidth(1)
              .fontSize(16)
              .onClick(() => {
                router.replaceUrl({ url: 'pages/LoginPage' });
              })
          }
          .width('100%')
          .padding(20)
          .backgroundColor('#FFFFFF')
          .borderRadius(12)

          // æŸ¥è¯¢ç»“æœåŒºåŸŸ - æ˜æ–‡æ˜¾ç¤ºåŸå¯†ç 
          if (this.showResult && this.foundPassword) {
            Column({ space: 16 }) {
              Text('âœ… æŸ¥è¯¢æˆåŠŸ')
                .fontSize(18)
                .fontWeight(FontWeight.Bold)
                .fontColor('#34C759')
                .width('100%')
                .textAlign(TextAlign.Center)

              Text('æ‚¨çš„åŸå¯†ç å¦‚ä¸‹ï¼š')
                .fontSize(14)
                .fontColor('#666666')
                .width('100%')
                .textAlign(TextAlign.Center)

              // æ˜æ–‡å¯†ç æ˜¾ç¤ºæ¡† - ä½¿ç”¨ Text ç›´æ¥æ˜¾ç¤º
              Column({ space: 8 }) {
                Text('åŸå¯†ç ')
                  .fontSize(12)
                  .fontColor('#999999')
                  .width('100%')
                  .textAlign(TextAlign.Start)

                // å…³é”®ä¿®æ”¹ï¼šä½¿ç”¨ Text ç›´æ¥æ˜æ–‡æ˜¾ç¤ºï¼Œçº¢è‰²å¤§å·å­—ä½“çªå‡ºæ˜¾ç¤º
                Text(this.foundPassword)
                  .fontSize(24) // å¤§å­—å·
                  .fontColor('#FF3B30') // çº¢è‰²
                  .fontWeight(FontWeight.Bold) // ç²—ä½“
                  .width('100%')
                  .height(60)
                  .backgroundColor('#FFF5F5') // æµ…çº¢èƒŒæ™¯
                  .borderRadius(8)
                  .padding({ left: 16, right: 16 })
                  .textAlign(TextAlign.Center) // å±…ä¸­æ˜¾ç¤º
              }
              .width('100%')
              .padding(16)
              .backgroundColor('#F5F5F5')
              .borderRadius(8)

              // å¤åˆ¶æŒ‰é’®
              Button('å¤åˆ¶å¯†ç ')
                .width('100%')
                .height(44)
                .backgroundColor('#34C759')
                .fontColor('#FFFFFF')
                .fontSize(16)
                .onClick(() => {
                  this.copyPassword();
                })

              // æç¤ºä¿¡æ¯
              Text('ğŸ’¡ æç¤ºï¼šè¯·ç‰¢è®°æ‚¨çš„å¯†ç ï¼Œæˆ–å¤åˆ¶ä¿å­˜åˆ°å®‰å…¨ä½ç½®')
                .fontSize(12)
                .fontColor('#007AFF')
                .width('100%')
                .textAlign(TextAlign.Start)
                .margin({ top: 8 })
            }
            .width('100%')
            .padding(20)
            .backgroundColor('#E8F5E9')
            .borderRadius(12)
            .margin({ top: 10 })
          }

          // å®‰å…¨æç¤º
          Column({ space: 8 }) {
            Text('ğŸ”’ å®‰å…¨æç¤º')
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
              .fontColor('#000000')
              .width('100%')

            Text('1. è¯·ç¡®ä¿æ‚¨æ˜¯è´¦å·çš„åˆæ³•æ‰€æœ‰è€…')
              .fontSize(13)
              .fontColor('#666666')
              .width('100%')

            Text('2. æŸ¥è¯¢ç»“æœè¯·å‹¿æ³„éœ²ç»™ä»–äºº')
              .fontSize(13)
              .fontColor('#666666')
              .width('100%')

            Text('3. å»ºè®®å®šæœŸä¿®æ”¹å¯†ç ä»¥ä¿è¯å®‰å…¨')
              .fontSize(13)
              .fontColor('#666666')
              .width('100%')
          }
          .width('100%')
          .padding(16)
          .backgroundColor('#FFF8E1')
          .borderRadius(12)
          .margin({ top: 10 })
        }
        .width('100%')
        .padding(20)
      }
      .width('100%')
      .height('100%')
      .backgroundColor('#F2F2F7')
      .scrollBar(BarState.Off)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F2F2F7')
  }
}