import router from '@ohos.router';
import promptAction from '@ohos.promptAction';
import { BusinessError } from '@ohos.base';
import { RecordStore } from '../data/RecordStore';
import { DateUtils } from '../utils/DateUtils';
import { Record, Category, TabItem } from '../models/Record';
import { CommonNavBar } from '../components/CommonNavBar';
import { CommonTabBar, DefaultTabItems } from '../components/CommonTabBar';
import pasteboard from '@ohos.pasteboard'; // å¯¼å…¥å‰ªè´´æ¿æ¨¡å—



interface RecordParams {
  recordId: string | number;
  refresh?: boolean,
  timestamp?: number
}

@Entry
@Component
struct DataBackupPage {
  private recordStore: RecordStore | undefined = undefined;
  @State currentIndex: number = 0;
  private tabItems: Array<TabItem> = DefaultTabItems;
  @State currentRecordId: string | number = '';
  @State currentRecord: Record | undefined = undefined;
  @State categoryInfo: Category | undefined = undefined;
  @State allRecords: Record[] = [];
  @State recentRecords: Record[] = [];
  @State foodExpenseTotal: number = 0;
  @State budgetTotal: number = 1000;
  @State showRecentRecords: boolean = false;
  @State refreshFlag: boolean = false;
  @State refreshTimestamp: number = 0;

  @State isGeneratingBackup: boolean = false;
  @State showBackupResult: boolean = false;
  @State backupContent: string = ''; // å­˜å‚¨ç”Ÿæˆçš„å¤‡ä»½æ–‡æœ¬



  async aboutToAppear(): Promise<void> {
    this.recordStore = RecordStore.getInstance();
    await this.recordStore.ready();

    const params = router.getParams() as RecordParams;

    if (params?.recordId) {
      this.currentRecordId = String(params.recordId);
      this.loadRecordData();
      this.showRecentRecords = false;
    } else {
      this.loadRecentRecords();
      this.showRecentRecords = true;
    }

    this.calculateFoodExpense();
  }

  // åŠ è½½å•æ¡è®°å½•æ•°æ®
  loadRecordData(): void {
    if (!this.recordStore) {
      return;
    }

    const allRecords = this.recordStore.getAllRecords();
    const record = allRecords.find(r => r.id === this.currentRecordId);

    if (record) {
      this.currentRecord = record;
      this.categoryInfo = this.recordStore.getCategoryById(record.category);
      console.log('åŠ è½½è®°å½•æ•°æ®æˆåŠŸ:', record.id, record.description);
    } else {
      console.log('è®°å½•ä¸å­˜åœ¨ï¼Œå¯èƒ½å·²è¢«åˆ é™¤:', this.currentRecordId);
      this.currentRecord = undefined;
      this.categoryInfo = undefined;
    }
  }

  // åŠ è½½æœ€è¿‘è®°å½•
  loadRecentRecords(): void {
    if (!this.recordStore) {
      return;
    }
    this.recentRecords = this.recordStore.getRecentRecords(10);
  }

  // é€‰æ‹©ä¸€æ¡è®°å½•æŸ¥çœ‹è¯¦æƒ…
  selectRecord(record: Record): void {
    this.currentRecord = record;
    this.categoryInfo = this.recordStore!.getCategoryById(record.category);
    this.showRecentRecords = false;
  }

  // è¿”å›æœ€è¿‘è®°å½•åˆ—è¡¨
  backToRecentRecords(): void {
    this.showRecentRecords = true;
    this.currentRecord = undefined;
    this.categoryInfo = undefined;
  }

  calculateFoodExpense(): void {
    if (!this.recordStore) {
      return;
    }

    const allRecords = this.recordStore.getAllRecords();
    const currentMonth = new Date().getMonth() + 1;

    let foodTotal = 0;
    allRecords.forEach(record => {
      if (record.type === 'expense' && record.category === 'food') {
        try {
          const GeneratedDestructArray_1 = record.date.split('-').map(Number);
          const year = GeneratedDestructArray_1[0];
          const month = GeneratedDestructArray_1[1];
          const day = GeneratedDestructArray_1[2];
          if (month === currentMonth) {
            foodTotal += record.amount;
          }
        } catch (e) {
          // æ—¥æœŸè§£æå¤±è´¥ï¼Œè·³è¿‡è¯¥è®°å½•
        }
      }
    });

    this.foodExpenseTotal = foodTotal;
  }

  // è·å–åˆ†ç±»é¢œè‰²
  private getCategoryColor(categoryId: string): string {
    if (!this.recordStore) return '#CCCCCC';
    const category = this.recordStore.getCategoryById(categoryId);
    return category?.color || '#CCCCCC';
  }

  // è·å–åˆ†ç±»åç§°
  private getCategoryName(categoryId: string): string {
    if (!this.recordStore) return 'æœªçŸ¥';
    const category = this.recordStore.getCategoryById(categoryId);
    return category?.name || 'æœªçŸ¥';
  }

  // è·å–æ ¼å¼åŒ–æ—¥æœŸ
  private getFormattedDate(): string {
    if (!this.currentRecord) {
      return '';
    }

    if (this.currentRecord.date === DateUtils.getCurrentDate()) {
      return 'ä»Šå¤© ' + this.currentRecord.time;
    } else if (this.currentRecord.date === DateUtils.getYesterdayDate()) {
      return 'æ˜¨å¤© ' + this.currentRecord.time;
    } else {
      return this.currentRecord.date + ' ' + this.currentRecord.time;
    }
  }

  // æ ¼å¼åŒ–é‡‘é¢æ˜¾ç¤º
  private formatAmount(amount: number, type: string): string {
    const prefix = type === 'expense' ? '-ï¿¥' : '+ï¿¥';
    return prefix + amount.toFixed(2);
  }

  // ====================== æ ¸å¿ƒä¿®æ”¹ï¼šç¡®è®¤å¼¹çª— ======================
  private async showConfirmBackupDialog() {
    if (this.isGeneratingBackup) return;

    try {
      // ç³»ç»Ÿç¡®è®¤å¼¹çª—
      let res = await promptAction.showDialog({
        title: "ç¡®è®¤ç”Ÿæˆå¤‡ä»½",
        message: "ç¡®å®šè¦ç”Ÿæˆå½“å‰æ•°æ®çš„å¤‡ä»½æ–‡æœ¬å—ï¼Ÿ\nç”Ÿæˆåå¯ç›´æ¥å¤åˆ¶ä½¿ç”¨",
        buttons: [
          { text: "å–æ¶ˆ", color: "#666666" },
          { text: "ç¡®è®¤", color: "#007AFF" },
        ]
      });

      // ç‚¹å‡»ç¡®è®¤ï¼Œç”Ÿæˆå¤‡ä»½æ–‡æœ¬å¹¶æ˜¾ç¤º
      if (res.index === 1) {
        await this.generateAndShowBackup();
      } else {
        promptAction.showToast({ message: "å·²å–æ¶ˆå¤‡ä»½", duration: 1500 });
      }
    } catch (err) {
      console.error("å¼¹çª—å¼‚å¸¸", err);
    }
  }
  // ===========================================================================

  // ç”Ÿæˆå¤‡ä»½å¹¶æ˜¾ç¤ºï¼ˆä¸ä¿å­˜æ–‡ä»¶ï¼Œç›´æ¥å±•ç¤ºæ–‡æœ¬ï¼‰
  private async generateAndShowBackup(): Promise<void> {
    if (this.isGeneratingBackup) {
      return;
    }

    this.isGeneratingBackup = true;

    try {
      promptAction.showToast({ message: 'æ­£åœ¨ç”Ÿæˆå¤‡ä»½...', duration: 800 });

      // ç”Ÿæˆå¤‡ä»½å†…å®¹
      this.backupContent = this.generateBackupContent();
      this.showBackupResult = true;

      promptAction.showToast({ message: 'å¤‡ä»½ç”ŸæˆæˆåŠŸ', duration: 1500 });

    } catch (error) {
      console.error('å¤‡ä»½ç”Ÿæˆå¤±è´¥:', error);
      promptAction.showToast({ message: 'ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•', duration: 2000 });
    } finally {
      this.isGeneratingBackup = false;
    }
  }

  // å¤åˆ¶æ–‡æœ¬åˆ°å‰ªè´´æ¿
  private async copyToClipboard(): Promise<void> {
    try {
      // åˆ›å»ºå‰ªè´´æ¿æ•°æ® [^11^]
      const pasteboardData = pasteboard.createData(pasteboard.MIMETYPE_TEXT_PLAIN, this.backupContent);
      const systemPasteboard = pasteboard.getSystemPasteboard();

      // è®¾ç½®æ•°æ®åˆ°ç³»ç»Ÿå‰ªè´´æ¿ï¼Œå…è®¸è·¨åº”ç”¨ç²˜è´´ [^21^]
      await systemPasteboard.setData(pasteboardData);

      promptAction.showToast({ message: 'å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', duration: 2000 });
    } catch (error) {
      console.error('å¤åˆ¶å¤±è´¥:', error);
      promptAction.showToast({ message: 'å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', duration: 2000 });
    }
  }

  // ç”Ÿæˆå¤‡ä»½æ–‡æœ¬å†…å®¹
  private generateBackupContent(): string {
    const timestamp = new Date().toLocaleString();
    let content = '=== è´¢åŠ¡è®°å½•å¤‡ä»½ ===\n';
    content += `å¤‡ä»½æ—¶é—´: ${timestamp}\n`;
    content += '===================\n\n';

    if (this.showRecentRecords) {
      content += 'ã€æœ€è¿‘è®°å½•ã€‘\n';
      content += '-----------\n';

      if (this.recentRecords.length > 0) {
        this.recentRecords.forEach((record, index) => {
          content += `${index + 1}. ${record.description || 'æ— æè¿°'}\n`;
          content += `   é‡‘é¢: ${this.formatAmount(record.amount, record.type)}\n`;
          content += `   åˆ†ç±»: ${this.getCategoryName(record.category)}\n`;
          content += `   æ—¶é—´: ${record.date} ${record.time}\n`;
          content += `   ç±»å‹: ${record.type === 'expense' ? 'æ”¯å‡º' : 'æ”¶å…¥'}\n\n`;
        });
      } else {
        content += 'æš‚æ— è®°å½•\n\n';
      }
    } else if (this.currentRecord) {
      content += 'ã€è¯¦ç»†è®°å½•ã€‘\n';
      content += '-----------\n';
      content += `æè¿°: ${this.currentRecord.description || 'æ— æè¿°'}\n`;
      content += `é‡‘é¢: ${this.formatAmount(this.currentRecord.amount, this.currentRecord.type)}\n`;
      content += `åˆ†ç±»: ${this.getCategoryName(this.currentRecord.category)}\n`;
      content += `æ—¶é—´: ${this.getFormattedDate()}\n`;
      content += `ç±»å‹: ${this.currentRecord.type === 'expense' ? 'æ”¯å‡º' : 'æ”¶å…¥'}\n`;
      content += `è®°å½•ID: ${this.currentRecord.id}\n\n`;

      // æ·»åŠ ç»Ÿè®¡ä¿¡æ¯
      content += 'ã€æœˆåº¦ç»Ÿè®¡ã€‘\n';
      content += '-----------\n';
      content += `æœ¬æœˆé¤é¥®æ¶ˆè´¹: Â¥${this.foodExpenseTotal.toFixed(2)}\n`;
      content += `é¤é¥®é¢„ç®—å‰©ä½™: Â¥${(this.budgetTotal - this.foodExpenseTotal).toFixed(2)}\n`;
    }

    content += '\n=== å¤‡ä»½ç»“æŸ ===\n';
    content += `è®°å½•æ€»æ•°: ${this.recentRecords.length}\n`;
    content += 'ç”Ÿæˆæ—¶é—´: ' + new Date().toISOString();

    return content;
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      CommonNavBar({
        options: {
          showBack: true,
          onLeftClick: () => {
            router.back();
          },
          title: 'æ•°æ®å¤‡ä»½',
        }
      });

      // ä¸»è¦å†…å®¹åŒºåŸŸ
      Scroll() {
        Column({ space: 20 }) {
          if (this.showRecentRecords) {
            // æ˜¾ç¤ºæœ€è¿‘è®°å½•åˆ—è¡¨
            if (this.recentRecords.length > 0) {
              Column({ space: 12 }) {
                Text('æœ€è¿‘è®°å½•')
                  .fontSize(20)
                  .fontWeight(FontWeight.Bold)
                  .fontColor('#000000')
                  .margin({ left: 8, top: 8, bottom: 8 })

                ForEach(this.recentRecords, (record: Record) => {
                  Column() {
                    Row({ space: 12 }) {
                      Column() {
                        Image($r(`app.media.category_${this.recordStore?.getCategoryById(record.category)?.icon}`))
                          .width(24)
                          .height(24)
                          .objectFit(ImageFit.Contain)
                      }
                      .width(40)
                      .height(40)
                      .backgroundColor(`${this.getCategoryColor(record.category)}20`)
                      .borderRadius(20)
                      .justifyContent(FlexAlign.Center)
                      .alignItems(HorizontalAlign.Center)

                      Column({ space: 4 }) {
                        Row() {
                          Text(record.description || 'æ— æè¿°')
                            .fontSize(16)
                            .fontColor('#000000')
                            .maxLines(1)
                            .textOverflow({ overflow: TextOverflow.Ellipsis })

                          Blank()

                          Text(this.formatAmount(record.amount, record.type))
                            .fontSize(16)
                            .fontColor(record.type === 'expense' ? '#FF3B30' : '#34C759')
                            .fontWeight(FontWeight.Medium)
                        }
                        .width('100%')
                        .height(24)

                        Row() {
                          Text(this.getCategoryName(record.category))
                            .fontSize(14)
                            .fontColor('#666666')

                          Text(' Â· ')
                            .fontSize(14)
                            .fontColor('#666666')

                          Text(record.date + ' ' + record.time)
                            .fontSize(14)
                            .fontColor('#666666')
                        }
                        .width('100%')
                        .height(20)
                      }
                      .layoutWeight(1)
                      .justifyContent(FlexAlign.SpaceBetween)
                    }
                    .width('100%')
                    .padding({ left: 16, right: 16, top: 12, bottom: 12 })
                    .backgroundColor('#FFFFFF')
                    .borderRadius(12)
                    .onClick(() => {
                      this.selectRecord(record);
                    })
                  }
                  .width('100%')
                })
              }
              .width('100%')
            } else {
              Column() {
                Image($r('app.media.background'))
                  .width(120)
                  .height(120)
                  .margin({ bottom: 20 })
                Text('æš‚æ— è®°å½•')
                  .fontSize(18)
                  .fontColor('#8E8E93')
                  .margin({ bottom: 8 })
                Text('ç‚¹å‡»é¦–é¡µçš„"+"æŒ‰é’®æ·»åŠ è®°å½•')
                  .fontSize(14)
                  .fontColor('#999999')
              }
              .width('100%')
              .height(400)
              .justifyContent(FlexAlign.Center)
              .alignItems(HorizontalAlign.Center)
            }
          } else if (this.currentRecord) {
            // æ˜¾ç¤ºå•æ¡è®°å½•è¯¦æƒ…
            Column({ space: 24 }) {
              Column() {
                Text(this.formatAmount(this.currentRecord.amount, this.currentRecord.type))
                  .fontSize(40)
                  .fontWeight(FontWeight.Bold)
                  .fontColor(this.currentRecord.type === 'expense' ? '#FF3B30' : '#34C759')

                Text(this.currentRecord.description || 'æ— æè¿°')
                  .fontSize(18)
                  .fontColor('#666666')
                  .margin({ top: 8 })
              }
              .width('100%')
              .padding({ top: 32, bottom: 32 })
              .backgroundColor('#FFFFFF')
              .alignItems(HorizontalAlign.Center)

              Column({ space: 16 }) {
                Text('è¯¦ç»†ä¿¡æ¯')
                  .fontSize(18)
                  .fontWeight(FontWeight.Medium)
                  .fontColor('#000000')
                  .margin({ left: 20, top: 20 })

                Row() {
                  Text('åˆ†ç±»ï¼š')
                    .fontSize(16)
                    .fontColor('#666666')
                    .width(100)

                  if (this.categoryInfo) {
                    Row() {
                      Circle({ width: 8, height: 8 })
                        .fill(this.categoryInfo.color)
                        .margin({ right: 8 })

                      Text(this.categoryInfo.name)
                        .fontSize(16)
                        .fontColor('#000000')
                    }
                  }
                }
                .width('100%')
                .padding({ left: 20, right: 20 })

                Row() {
                  Text('æ—¶é—´ï¼š')
                    .fontSize(16)
                    .fontColor('#666666')
                    .width(100)

                  Text(this.getFormattedDate())
                    .fontSize(16)
                    .fontColor('#000000')
                }
                .width('100%')
                .padding({ left: 20, right: 20 })

                Row() {
                  Text('ç±»å‹ï¼š')
                    .fontSize(16)
                    .fontColor('#666666')
                    .width(100)

                  Text(this.currentRecord.type === 'expense' ? 'æ”¯å‡º' : 'æ”¶å…¥')
                    .fontSize(16)
                    .fontColor(this.currentRecord.type === 'expense' ? '#FF3B30' : '#34C759')
                }
                .width('100%')
                .padding({ left: 20, right: 20 })

                Row() {
                  Text('è®°å½•IDï¼š')
                    .fontSize(16)
                    .fontColor('#666666')
                    .width(100)

                  Text(this.currentRecord.id)
                    .fontSize(16)
                    .fontColor('#999999')
                }
                .width('100%')
                .padding({ left: 20, right: 20 })
              }
              .width('100%')
              .backgroundColor('#FFFFFF')
              .borderRadius(12)

              if (this.currentRecord.type === 'expense' && this.currentRecord.category === 'food') {
                Column() {
                  Text('æœ¬æœˆé¤é¥®å·²æ¶ˆè´¹ Â¥' + this.foodExpenseTotal.toFixed(2))
                    .fontSize(16)
                    .fontColor('#000000')

                  Text('é¢„ç®—å‰©ä½™ Â¥' + (this.budgetTotal - this.foodExpenseTotal).toFixed(2))
                    .fontSize(16)
                    .fontColor('#34C759')
                    .fontWeight(FontWeight.Medium)
                    .margin({ top: 4 })
                }
                .width('100%')
                .padding({ top: 16, bottom: 16 })
                .backgroundColor('#F2F2F7')
                .borderRadius(12)
                .alignItems(HorizontalAlign.Center)
              }
            }
          }

          // ====================== æ ¸å¿ƒä¿®æ”¹ï¼šå¤‡ä»½ç»“æœæ˜¾ç¤ºåŒºåŸŸ ======================
          if (this.showBackupResult && this.backupContent) {
            Column({ space: 12 }) {
              Row() {
                Text('ğŸ“‹ å¤‡ä»½å†…å®¹')
                  .fontSize(18)
                  .fontWeight(FontWeight.Bold)
                  .fontColor('#000000')

                Blank()

                // å¤åˆ¶æŒ‰é’®
                Button('ä¸€é”®å¤åˆ¶')
                  .fontSize(14)
                  .height(32)
                  .backgroundColor('#007AFF')
                  .onClick(() => {
                    this.copyToClipboard();
                  })
              }
              .width('100%')

              // ä½¿ç”¨ TextArea æ›¿ä»£ TextInputï¼Œæ”¯æŒå¤šè¡Œè‡ªåŠ¨æ¢è¡Œ [^23^][^26^]
              TextArea({ text: this.backupContent })
                .width('100%')
                .height(300)
                .fontSize(14)
                .fontColor('#333333')
                .backgroundColor('#F5F5F5')
                .padding(12)
                .borderRadius(8)
                .enabled(true) // å…è®¸äº¤äº’é€‰æ‹©æ–‡æœ¬
                .copyOption(CopyOptions.LocalDevice) // å…è®¸å¤åˆ¶ [^13^]

              Text('æç¤ºï¼šç‚¹å‡»"ä¸€é”®å¤åˆ¶"å¯ç›´æ¥å¤åˆ¶å…¨éƒ¨å†…å®¹ï¼Œæˆ–é•¿æŒ‰ä¸Šæ–¹æ–‡æœ¬æ¡†æ‰‹åŠ¨é€‰æ‹©å¤åˆ¶')
                .fontSize(12)
                .fontColor('#999999')
                .width('100%')
                .textAlign(TextAlign.Center)
            }
            .width('100%')
            .padding(16)
            .backgroundColor('#E8F4FD')
            .borderRadius(12)
            .margin({ top: 10 })
          }
          // ===========================================================================

          // å¤‡ä»½è¯´æ˜ï¼ˆä»…åœ¨æœªç”Ÿæˆå¤‡ä»½æ—¶æ˜¾ç¤ºï¼‰
          if (!this.showBackupResult) {
            Column({ space: 8 }) {
              Text('å¤‡ä»½è¯´æ˜')
                .fontSize(18)
                .fontWeight(FontWeight.Bold)
                .fontColor('#000000')
                .margin({ bottom: 12 })

              Text('ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ç”Ÿæˆå¤‡ä»½æ–‡æœ¬')
                .fontSize(14)
                .fontColor('#666666')
              Text('ç”Ÿæˆåå¯ç›´æ¥å¤åˆ¶æˆ–æ‰‹åŠ¨é€‰æ‹©æ–‡æœ¬')
                .fontSize(14)
                .fontColor('#666666')
            }
            .width('100%')
            .padding(16)
            .backgroundColor('#FFFFFF')
            .borderRadius(12)
            .margin({ top: 20 })
          }
        }
        .width('100%')
        .padding(20)
      }
      .width('100%')
      .height('85%')
      .backgroundColor('#F2F2F7')
      .scrollBar(BarState.Off)

      // åº•éƒ¨å¤‡ä»½æŒ‰é’®
      Column() {
        Button(this.showBackupResult ? 'é‡æ–°ç”Ÿæˆå¤‡ä»½' : 'ç”Ÿæˆå¤‡ä»½æ–‡æœ¬')
          .fontSize(18)
          .fontColor('#FFFFFF')
          .backgroundColor(this.isGeneratingBackup ? '#CCCCCC' : '#007AFF')
          .width('90%')
          .height(50)
          .borderRadius(25)
          .enabled(!this.isGeneratingBackup)
          .onClick(() => {
            if (this.showBackupResult) {
              // å¦‚æœå·²ç»æ˜¾ç¤ºç»“æœï¼Œç‚¹å‡»åˆ™é‡æ–°ç”Ÿæˆ
              this.generateAndShowBackup();
            } else {
              // é¦–æ¬¡ç‚¹å‡»æ˜¾ç¤ºç¡®è®¤å¼¹çª—
              this.showConfirmBackupDialog();
            }
          })

        if (this.isGeneratingBackup) {
          LoadingProgress()
            .width(30)
            .height(30)
            .color('#007AFF')
            .margin({ top: 10 })
        }

        Text(this.showBackupResult ? 'å·²ç”Ÿæˆå¤‡ä»½æ–‡æœ¬ï¼Œè¯·å¤åˆ¶ä½¿ç”¨' : 'ç‚¹å‡»ç”Ÿæˆå¯å¤åˆ¶çš„å¤‡ä»½æ–‡æœ¬')
          .fontSize(12)
          .fontColor('#999999')
          .margin({ top: 8 })
      }
      .width('100%')
      .height('15%')
      .backgroundColor('#FFFFFF')
      .justifyContent(FlexAlign.Center)
      .alignItems(HorizontalAlign.Center)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F2F2F7')
  }
}