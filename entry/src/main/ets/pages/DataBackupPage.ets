import router from '@ohos.router';
import promptAction from '@ohos.promptAction';
import { RecordStore } from '../data/RecordStore';
import { DateUtils } from '../utils/DateUtils';
import { Record, Category, TabItem } from '../models/Record';
import { CommonNavBar } from '../components/CommonNavBar';
import { CommonTabBar, DefaultTabItems } from '../components/CommonTabBar';
import fs from '@ohos.file.fs';
import common from '@ohos.app.ability.common';


interface RecordParams {
  recordId: string | number;
  refresh?: boolean,
  timestamp?: number
}


interface GeneratedObjectLiteralInterface_1 {
  action: string;
  type: string;
  uri: string;
}

@Entry
@Component
struct DataBackupPage {
  private recordStore: RecordStore | undefined = undefined;
  @State currentIndex: number = 0;
  private tabItems: Array<TabItem> = DefaultTabItems;
  @State currentRecordId: string | number = '';
  @State currentRecord: Record | undefined = undefined;
  @State categoryInfo: Category | undefined = undefined;
  @State allRecords: Record[] = [];
  @State recentRecords: Record[] = [];
  @State foodExpenseTotal: number = 0;
  @State budgetTotal: number = 1000;
  @State showRecentRecords: boolean = false;
  @State refreshFlag: boolean = false;
  @State refreshTimestamp: number = 0;

  @State isGeneratingImage: boolean = false;
  @State backupFilePath: string = '';
  @State showBackupSuccess: boolean = false;

  async aboutToAppear(): Promise<void> {
    this.recordStore = RecordStore.getInstance();
    await this.recordStore.ready();

    const params = router.getParams() as RecordParams;

    if (params?.recordId) {
      this.currentRecordId = String(params.recordId);
      this.loadRecordData();
      this.showRecentRecords = false;
    } else {
      this.loadRecentRecords();
      this.showRecentRecords = true;
    }

    this.calculateFoodExpense();
  }

  // åŠ è½½å•æ¡è®°å½•æ•°æ®
  loadRecordData(): void {
    if (!this.recordStore) {
      return;
    }

    const allRecords = this.recordStore.getAllRecords();
    const record = allRecords.find(r => r.id === this.currentRecordId);

    if (record) {
      this.currentRecord = record;
      this.categoryInfo = this.recordStore.getCategoryById(record.category);
      console.log('åŠ è½½è®°å½•æ•°æ®æˆåŠŸ:', record.id, record.description);
    } else {
      console.log('è®°å½•ä¸å­˜åœ¨ï¼Œå¯èƒ½å·²è¢«åˆ é™¤:', this.currentRecordId);
      this.currentRecord = undefined;
      this.categoryInfo = undefined;
    }
  }

  // åŠ è½½æ‰€æœ‰è®°å½•
  loadAllRecords(): void {
    if (!this.recordStore) {
      return;
    }
    this.allRecords = this.recordStore.getAllRecords();
  }

  // åŠ è½½æœ€è¿‘è®°å½•
  loadRecentRecords(): void {
    if (!this.recordStore) {
      return;
    }
    this.recentRecords = this.recordStore.getRecentRecords(10);
  }

  // é€‰æ‹©ä¸€æ¡è®°å½•æŸ¥çœ‹è¯¦æƒ…
  selectRecord(record: Record): void {
    this.currentRecord = record;
    this.categoryInfo = this.recordStore!.getCategoryById(record.category);
    this.showRecentRecords = false;
  }

  // è¿”å›æœ€è¿‘è®°å½•åˆ—è¡¨
  backToRecentRecords(): void {
    this.showRecentRecords = true;
    this.currentRecord = undefined;
    this.categoryInfo = undefined;
  }

  calculateFoodExpense(): void {
    if (!this.recordStore) {
      return;
    }

    const allRecords = this.recordStore.getAllRecords();
    const currentMonth = new Date().getMonth() + 1;

    let foodTotal = 0;
    allRecords.forEach(record => {
      if (record.type === 'expense' && record.category === 'food') {
        try {
          const GeneratedDestructArray_1 = record.date.split('-').map(Number);
          const year = GeneratedDestructArray_1[0];
          const month = GeneratedDestructArray_1[1];
          const day = GeneratedDestructArray_1[2];
          if (month === currentMonth) {
            foodTotal += record.amount;
          }
        } catch (e) {
          // æ—¥æœŸè§£æå¤±è´¥ï¼Œè·³è¿‡è¯¥è®°å½•
        }
      }
    });

    this.foodExpenseTotal = foodTotal;
  }

  // è·å–åˆ†ç±»é¢œè‰²
  private getCategoryColor(categoryId: string): string {
    if (!this.recordStore) return '#CCCCCC';
    const category = this.recordStore.getCategoryById(categoryId);
    return category?.color || '#CCCCCC';
  }

  // è·å–åˆ†ç±»åç§°
  private getCategoryName(categoryId: string): string {
    if (!this.recordStore) return 'æœªçŸ¥';
    const category = this.recordStore.getCategoryById(categoryId);
    return category?.name || 'æœªçŸ¥';
  }

  // è·å–æ ¼å¼åŒ–æ—¥æœŸ
  private getFormattedDate(): string {
    if (!this.currentRecord) {
      return '';
    }

    if (this.currentRecord.date === DateUtils.getCurrentDate()) {
      return 'ä»Šå¤© ' + this.currentRecord.time;
    } else if (this.currentRecord.date === DateUtils.getYesterdayDate()) {
      return 'æ˜¨å¤© ' + this.currentRecord.time;
    } else {
      return this.currentRecord.date + ' ' + this.currentRecord.time;
    }
  }

  // æ ¼å¼åŒ–é‡‘é¢æ˜¾ç¤º
  private formatAmount(amount: number, type: string): string {
    const prefix = type === 'expense' ? '-ï¿¥' : '+ï¿¥';
    return prefix + amount.toFixed(2);
  }

  // ç”Ÿæˆå¹¶ä¿å­˜å¤‡ä»½ - ä¿®æ”¹ä¸ºæ–¹æ¡ˆä¸€
  private async saveAndShareBackup(): Promise<void> {
    if (this.isGeneratingImage) {
      return;
    }

    this.isGeneratingImage = true;
    this.showBackupSuccess = false;

    try {
      promptAction.showToast({ message: 'æ­£åœ¨ç”Ÿæˆå¤‡ä»½...', duration: 1000 });

      // ç”Ÿæˆå¤‡ä»½å†…å®¹
      const backupContent = this.generateBackupContent();

      // ä¿å­˜åˆ°åº”ç”¨ç§æœ‰ç›®å½•ï¼ˆä¸éœ€è¦é¢å¤–æƒé™ï¼‰
      const context = getContext() as common.UIAbilityContext;
      const filesDir = context.filesDir;
      const fileName = `è´¢åŠ¡è®°å½•å¤‡ä»½_${new Date().toLocaleDateString().replace(/\//g, '-')}.txt`;
      const filePath = `${filesDir}/${fileName}`;

      // å†™å…¥æ–‡ä»¶
      const file = await fs.open(filePath, fs.OpenMode.READ_WRITE | fs.OpenMode.CREATE);
      await fs.write(file.fd, backupContent);
      await fs.close(file.fd);

      console.log('æ–‡ä»¶å·²ä¿å­˜åˆ°åº”ç”¨ç›®å½•:', filePath);
      this.backupFilePath = filePath;
      this.showBackupSuccess = true;

      // ç›´æ¥è°ƒç”¨ç³»ç»Ÿåˆ†äº«
      await this.shareFileDirectly(filePath, backupContent);

    } catch (error) {
      console.error('å¤‡ä»½å¤±è´¥:', error);
      promptAction.showToast({ message: 'å¤‡ä»½å¤±è´¥: ' + error.message, duration: 3000 });
    } finally {
      this.isGeneratingImage = false;
    }
  }

  shareFileDirectly(filePath: string, backupContent: string) {
    throw new Error('Method not implemented.');
  }

  // æœ€ç®€å•çš„åˆ†äº«æ–¹æ³•
  private async shareFile(filePath: string): Promise<void> {
    try {
      const context = getContext() as common.UIAbilityContext;
      const fileName = filePath.split('/').pop() || 'è´¢åŠ¡è®°å½•å¤‡ä»½.txt';

      // æ–¹æ³•1ï¼šä½¿ç”¨uriæ–¹å¼
      const want1: GeneratedObjectLiteralInterface_1 = {
        action: 'ohos.want.action.sendFile',
        type: 'text/plain',
        uri: `file://${filePath}`
      };

      // å°è¯•ç¬¬ä¸€ç§æ–¹å¼ï¼Œå¤±è´¥æ—¶å°è¯•ç¬¬äºŒç§
        await context.startAbility(want1);



      console.log('åˆ†äº«æ–‡ä»¶æˆåŠŸ');
    } catch (error) {
      console.error('åˆ†äº«æ–‡ä»¶å¤±è´¥:', error);
      // é”™è¯¯å¤„ç†...
    }
  }

  // æ˜¾ç¤ºå¤‡ä»½å†…å®¹è®©ç”¨æˆ·æ‰‹åŠ¨å¤åˆ¶
  private async showBackupContent(content: string): Promise<void> {
    try {
      // è®¡ç®—æ˜¾ç¤ºçš„è¡Œæ•°ï¼ˆå‰30è¡Œï¼‰
      const lines = content.split('\n');
      const previewLines = lines.slice(0, Math.min(30, lines.length));
      const previewContent = previewLines.join('\n');

      const result = await promptAction.showDialog({
        title: 'ğŸ“‹ å¤‡ä»½å†…å®¹',
        message: `å¤‡ä»½å·²ç”Ÿæˆï¼\n\nç”±äºç³»ç»Ÿé™åˆ¶ï¼Œæ–‡ä»¶å·²ä¿å­˜åˆ°åº”ç”¨ç§æœ‰ç›®å½•ã€‚\n\nä»¥ä¸‹æ˜¯å¤‡ä»½å†…å®¹ï¼ˆå‰${previewLines.length}è¡Œï¼‰ï¼š\n\n${previewContent}\n\n... ${lines.length - previewLines.length} è¡Œæ›´å¤šå†…å®¹\n\næ‚¨å¯ä»¥é€‰æ‹©ï¼š`,
        buttons: [
          {
            text: 'æŸ¥çœ‹å®Œæ•´å†…å®¹',
            color: '#666666'
          },
          {
            text: 'å¤åˆ¶æ–‡æœ¬å†…å®¹',
            color: '#007AFF'
          }
        ]
      });

      if (result.index === 0) {
        // æ˜¾ç¤ºå®Œæ•´å†…å®¹
        await this.showFullContent(content);
      } else if (result.index === 1) {
        // æç¤ºç”¨æˆ·æ‰‹åŠ¨å¤åˆ¶
        await this.showCopyInstructions(content);
      }

    } catch (error) {
      console.error('æ˜¾ç¤ºå†…å®¹å¤±è´¥:', error);
    }
  }

  // æ˜¾ç¤ºå®Œæ•´å†…å®¹
  private async showFullContent(content: string): Promise<void> {
    try {
      promptAction.showDialog({
        title: 'ğŸ“„ å®Œæ•´å¤‡ä»½å†…å®¹',
        message: content,
        buttons: [{
          text: 'å…³é—­',
          color: '#007AFF'
        }]
      });
    } catch (error) {
      console.error('æ˜¾ç¤ºå®Œæ•´å†…å®¹å¤±è´¥:', error);
    }
  }

  // æ˜¾ç¤ºå¤åˆ¶è¯´æ˜
  private async showCopyInstructions(content: string): Promise<void> {
    try {
      // æ˜¾ç¤ºæ“ä½œæŒ‡å¼•
      promptAction.showDialog({
        title: 'ğŸ“‹ å¤åˆ¶è¯´æ˜',
        message: 'è¯·æŒ‰ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š\n\n1. è¿”å›ä¸Šä¸€ä¸ªå¯¹è¯æ¡†\n2. é•¿æŒ‰å¤‡ä»½å†…å®¹æ–‡æœ¬\n3. é€‰æ‹©"å…¨é€‰"\n4. é€‰æ‹©"å¤åˆ¶"\n5. ç²˜è´´åˆ°å¤‡å¿˜å½•ã€å¾®ä¿¡æˆ–å…¶ä»–åº”ç”¨\n\næˆ–è€…æ‚¨å¯ä»¥é€‰æ‹©é‡æ–°ç”Ÿæˆå¹¶å°è¯•åˆ†äº«ã€‚',
        buttons: [
          {
            text: 'è¿”å›æŸ¥çœ‹å†…å®¹',
            color: '#666666'
          },
          {
            text: 'é‡æ–°ç”Ÿæˆå¤‡ä»½',
            color: '#007AFF'
          }
        ]
      }).then(result => {
        if (result.index === 0) {
          this.showFullContent(content);
        } else if (result.index === 1) {
          this.saveAndShareBackup();
        }
      });
    } catch (error) {
      promptAction.showToast({ message: 'æ“ä½œå¤±è´¥', duration: 2000 });
    }
  }

  // ç”Ÿæˆå¤‡ä»½æ–‡æœ¬å†…å®¹
  private generateBackupContent(): string {
    const timestamp = new Date().toLocaleString();
    let content = '=== è´¢åŠ¡è®°å½•å¤‡ä»½ ===\n';
    content += `å¤‡ä»½æ—¶é—´: ${timestamp}\n`;
    content += '===================\n\n';

    if (this.showRecentRecords) {
      content += 'æœ€è¿‘è®°å½•:\n';
      content += '-----------\n';

      if (this.recentRecords.length > 0) {
        this.recentRecords.forEach((record, index) => {
          content += `${index + 1}. ${record.description || 'æ— æè¿°'}\n`;
          content += `   é‡‘é¢: ${this.formatAmount(record.amount, record.type)}\n`;
          content += `   åˆ†ç±»: ${this.getCategoryName(record.category)}\n`;
          content += `   æ—¶é—´: ${record.date} ${record.time}\n`;
          content += `   ç±»å‹: ${record.type === 'expense' ? 'æ”¯å‡º' : 'æ”¶å…¥'}\n\n`;
        });
      } else {
        content += 'æš‚æ— è®°å½•\n\n';
      }
    } else if (this.currentRecord) {
      content += 'è¯¦ç»†è®°å½•:\n';
      content += '-----------\n';
      content += `æè¿°: ${this.currentRecord.description || 'æ— æè¿°'}\n`;
      content += `é‡‘é¢: ${this.formatAmount(this.currentRecord.amount, this.currentRecord.type)}\n`;
      content += `åˆ†ç±»: ${this.getCategoryName(this.currentRecord.category)}\n`;
      content += `æ—¶é—´: ${this.getFormattedDate()}\n`;
      content += `ç±»å‹: ${this.currentRecord.type === 'expense' ? 'æ”¯å‡º' : 'æ”¶å…¥'}\n`;
      content += `è®°å½•ID: ${this.currentRecord.id}\n\n`;

      // æ·»åŠ ç»Ÿè®¡ä¿¡æ¯
      content += 'æœˆåº¦ç»Ÿè®¡:\n';
      content += '-----------\n';
      content += `æœ¬æœˆé¤é¥®æ¶ˆè´¹: Â¥${this.foodExpenseTotal.toFixed(2)}\n`;
      content += `é¤é¥®é¢„ç®—å‰©ä½™: Â¥${(this.budgetTotal - this.foodExpenseTotal).toFixed(2)}\n`;
    }

    content += '\n=== å¤‡ä»½ç»“æŸ ===\n';
    content += `è®°å½•æ€»æ•°: ${this.recentRecords.length}\n`;
    content += 'ç”Ÿæˆæ—¶é—´: ' + new Date().toISOString();

    return content;
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      CommonNavBar({
        options: {
          showBack: true,
          onLeftClick: () => {
            router.back();
          },
          title: 'æ•°æ®å¤‡ä»½',
        }
      });

      // ä¸»è¦å†…å®¹åŒºåŸŸ
      Scroll() {
        Column({ space: 24 }) {
          if (this.showRecentRecords) {
            // æ˜¾ç¤ºæœ€è¿‘è®°å½•åˆ—è¡¨
            if (this.recentRecords.length > 0) {
              Column({ space: 12 }) {
                Text('æœ€è¿‘è®°å½•')
                  .fontSize(20)
                  .fontWeight(FontWeight.Bold)
                  .fontColor('#000000')
                  .margin({ left: 8, top: 8, bottom: 8 })

                ForEach(this.recentRecords, (record: Record) => {
                  Column() {
                    Row({ space: 12 }) {
                      Column() {
                        Image($r(`app.media.category_${this.recordStore?.getCategoryById(record.category)?.icon}`))
                          .width(24)
                          .height(24)
                          .objectFit(ImageFit.Contain)
                      }
                      .width(40)
                      .height(40)
                      .backgroundColor(`${this.getCategoryColor(record.category)}20`)
                      .borderRadius(20)
                      .justifyContent(FlexAlign.Center)
                      .alignItems(HorizontalAlign.Center)

                      Column({ space: 4 }) {
                        Row() {
                          Text(record.description || 'æ— æè¿°')
                            .fontSize(16)
                            .fontColor('#000000')
                            .maxLines(1)
                            .textOverflow({ overflow: TextOverflow.Ellipsis })

                          Blank()

                          Text(this.formatAmount(record.amount, record.type))
                            .fontSize(16)
                            .fontColor(record.type === 'expense' ? '#FF3B30' : '#34C759')
                            .fontWeight(FontWeight.Medium)
                        }
                        .width('100%')
                        .height(24)

                        Row() {
                          Text(this.getCategoryName(record.category))
                            .fontSize(14)
                            .fontColor('#666666')

                          Text(' Â· ')
                            .fontSize(14)
                            .fontColor('#666666')

                          Text(record.date + ' ' + record.time)
                            .fontSize(14)
                            .fontColor('#666666')
                        }
                        .width('100%')
                        .height(20)
                      }
                      .layoutWeight(1)
                      .justifyContent(FlexAlign.SpaceBetween)
                    }
                    .width('100%')
                    .padding({ left: 16, right: 16, top: 12, bottom: 12 })
                    .backgroundColor('#FFFFFF')
                    .borderRadius(12)
                    .onClick(() => {
                      this.selectRecord(record);
                    })
                  }
                  .width('100%')
                })
              }
              .width('100%')
            } else {
              Column() {
                Image($r('app.media.background'))
                  .width(120)
                  .height(120)
                  .margin({ bottom: 20 })
                Text('æš‚æ— è®°å½•')
                  .fontSize(18)
                  .fontColor('#8E8E93')
                  .margin({ bottom: 8 })
                Text('ç‚¹å‡»é¦–é¡µçš„"+"æŒ‰é’®æ·»åŠ è®°å½•')
                  .fontSize(14)
                  .fontColor('#999999')
              }
              .width('100%')
              .height(400)
              .justifyContent(FlexAlign.Center)
              .alignItems(HorizontalAlign.Center)
            }
          } else if (this.currentRecord) {
            // æ˜¾ç¤ºå•æ¡è®°å½•è¯¦æƒ…
            Column({ space: 24 }) {
              Column() {
                Text(this.formatAmount(this.currentRecord.amount, this.currentRecord.type))
                  .fontSize(40)
                  .fontWeight(FontWeight.Bold)
                  .fontColor(this.currentRecord.type === 'expense' ? '#FF3B30' : '#34C759')

                Text(this.currentRecord.description || 'æ— æè¿°')
                  .fontSize(18)
                  .fontColor('#666666')
                  .margin({ top: 8 })
              }
              .width('100%')
              .padding({ top: 32, bottom: 32 })
              .backgroundColor('#FFFFFF')
              .alignItems(HorizontalAlign.Center)

              Column({ space: 16 }) {
                Text('è¯¦ç»†ä¿¡æ¯')
                  .fontSize(18)
                  .fontWeight(FontWeight.Medium)
                  .fontColor('#000000')
                  .margin({ left: 20, top: 20 })

                Row() {
                  Text('åˆ†ç±»ï¼š')
                    .fontSize(16)
                    .fontColor('#666666')
                    .width(100)

                  if (this.categoryInfo) {
                    Row() {
                      Circle({ width: 8, height: 8 })
                        .fill(this.categoryInfo.color)
                        .margin({ right: 8 })

                      Text(this.categoryInfo.name)
                        .fontSize(16)
                        .fontColor('#000000')
                    }
                  }
                }
                .width('100%')
                .padding({ left: 20, right: 20 })

                Row() {
                  Text('æ—¶é—´ï¼š')
                    .fontSize(16)
                    .fontColor('#666666')
                    .width(100)

                  Text(this.getFormattedDate())
                    .fontSize(16)
                    .fontColor('#000000')
                }
                .width('100%')
                .padding({ left: 20, right: 20 })

                Row() {
                  Text('ç±»å‹ï¼š')
                    .fontSize(16)
                    .fontColor('#666666')
                    .width(100)

                  Text(this.currentRecord.type === 'expense' ? 'æ”¯å‡º' : 'æ”¶å…¥')
                    .fontSize(16)
                    .fontColor(this.currentRecord.type === 'expense' ? '#FF3B30' : '#34C759')
                }
                .width('100%')
                .padding({ left: 20, right: 20 })

                Row() {
                  Text('è®°å½•IDï¼š')
                    .fontSize(16)
                    .fontColor('#666666')
                    .width(100)

                  Text(this.currentRecord.id)
                    .fontSize(16)
                    .fontColor('#999999')
                }
                .width('100%')
                .padding({ left: 20, right: 20 })
              }
              .width('100%')
              .backgroundColor('#FFFFFF')
              .borderRadius(12)

              if (this.currentRecord.type === 'expense' && this.currentRecord.category === 'food') {
                Column() {
                  Text('æœ¬æœˆé¤é¥®å·²æ¶ˆè´¹ Â¥' + this.foodExpenseTotal.toFixed(2))
                    .fontSize(16)
                    .fontColor('#000000')

                  Text('é¢„ç®—å‰©ä½™ Â¥' + (this.budgetTotal - this.foodExpenseTotal).toFixed(2))
                    .fontSize(16)
                    .fontColor('#34C759')
                    .fontWeight(FontWeight.Medium)
                    .margin({ top: 4 })
                }
                .width('100%')
                .padding({ top: 16, bottom: 16 })
                .backgroundColor('#F2F2F7')
                .borderRadius(12)
                .alignItems(HorizontalAlign.Center)
              }
            }
          } else {
            Column() {
              Image($r('app.media.background'))
                .width(120)
                .height(120)
                .margin({ bottom: 20 })
              Text('æ— è®°å½•æ•°æ®')
                .fontSize(18)
                .fontColor('#8E8E93')
                .margin({ bottom: 20 })
            }
            .width('100%')
            .height(400)
            .justifyContent(FlexAlign.Center)
            .alignItems(HorizontalAlign.Center)
          }

          // å¤‡ä»½è¯´æ˜
          Column({ space: 8 }) {
            Text('å¤‡ä»½è¯´æ˜')
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .fontColor('#000000')
              .margin({ bottom: 12 })

            Text('ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å°†ç”Ÿæˆå¤‡ä»½æ–‡ä»¶')
              .fontSize(14)
              .fontColor('#666666')
            Text('ç³»ç»Ÿä¼šè‡ªåŠ¨å¼¹å‡ºåˆ†äº«èœå•')
              .fontSize(14)
              .fontColor('#666666')
            Text('æ‚¨å¯ä»¥é€‰æ‹©åˆ†äº«åˆ°å¾®ä¿¡ã€QQã€é‚®ç®±ç­‰')
              .fontSize(14)
              .fontColor('#666666')
          }
          .width('100%')
          .padding(16)
          .backgroundColor('#FFFFFF')
          .borderRadius(12)
          .margin({ top: 20, bottom: 10 })

          // æ˜¾ç¤ºå¤‡ä»½æˆåŠŸä¿¡æ¯
          if (this.showBackupSuccess && this.backupFilePath) {
            Column({ space: 8 }) {
              Text('âœ… å¤‡ä»½å·²ç”Ÿæˆ')
                .fontSize(16)
                .fontColor('#34C759')
                .fontWeight(FontWeight.Bold)

              Text('å¦‚æœæœªå¼¹å‡ºåˆ†äº«èœå•ï¼Œè¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®é‡æ–°åˆ†äº«')
                .fontSize(14)
                .fontColor('#666666')
                .margin({ top: 4 })

              Button('é‡æ–°åˆ†äº«')
                .fontSize(14)
                .height(36)
                .margin({ top: 8 })
                .onClick(async () => {
                  const backupContent = this.generateBackupContent();
                  await this.shareFileDirectly(this.backupFilePath, backupContent);
                })
            }
            .width('100%')
            .padding(16)
            .backgroundColor('#E8F5E9')
            .borderRadius(12)
            .margin({ top: 10 })
          }
        }
        .width('100%')
        .padding(20)
      }
      .width('100%')
      .height('85%')
      .backgroundColor('#F2F2F7')
      .scrollBar(BarState.Off)

      // åº•éƒ¨å¤‡ä»½æŒ‰é’®
      Column() {
        Button('ç”Ÿæˆå¹¶åˆ†äº«å¤‡ä»½')
          .fontSize(18)
          .fontColor('#FFFFFF')
          .backgroundColor(this.isGeneratingImage ? '#CCCCCC' : '#007AFF')
          .width('90%')
          .height(50)
          .borderRadius(25)
          .enabled(!this.isGeneratingImage)
          .onClick(() => {
            this.saveAndShareBackup();
          })

        if (this.isGeneratingImage) {
          LoadingProgress()
            .width(30)
            .height(30)
            .color('#007AFF')
            .margin({ top: 10 })
        }

        Text('ç‚¹å‡»åè¯·ç•™æ„ç³»ç»Ÿåˆ†äº«èœå•')
          .fontSize(12)
          .fontColor('#999999')
          .margin({ top: 8 })
      }
      .width('100%')
      .height('15%')
      .backgroundColor('#FFFFFF')
      .justifyContent(FlexAlign.Center)
      .alignItems(HorizontalAlign.Center)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F2F2F7')
  }
}